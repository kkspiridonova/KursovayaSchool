<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель преподавателя - Онлайн Школа</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .teacher-card {
            transition: transform 0.2s;
        }
        .teacher-card:hover {
            transform: translateY(-5px);
        }
        .tab-content {
            min-height: 400px;
        }
        .course-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand" href="/">Онлайн Школа - Панель преподавателя</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" th:if="${#authentication != null}">
                    Добро пожаловать, <span th:text="${#authentication.name}"></span>!
                </span>
                <a class="nav-link" href="/logout">Выйти</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="my-courses-tab" data-bs-toggle="tab" data-bs-target="#my-courses" type="button" role="tab" aria-controls="my-courses" aria-selected="true">Мои курсы</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Профиль</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="teacherTabsContent">
            <!-- My Courses Tab -->
            <div class="tab-pane fade show active" id="my-courses" role="tabpanel" aria-labelledby="my-courses-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Мои курсы</h3>
                        <p class="text-muted">Здесь представлены курсы, которые вы ведете.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Ваши курсы</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddCourseModal()">
                                    <i class="fas fa-plus"></i> Добавить курс
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="myCoursesList">
                                    <p class="text-muted text-center">Загрузка списка ваших курсов...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipts Tab -->
            <div class="tab-pane fade" id="receipts" role="tabpanel" aria-labelledby="receipts-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Чеки за мои курсы</h3>
                        <p class="text-muted">Здесь представлены чеки за оплаченные курсы, которые вы ведете.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Список чеков</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadMyReceipts()">
                                    <i class="fas fa-sync-alt"></i> Обновить
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="receiptsList">
                                    <p class="text-muted text-center">Загрузка списка чеков...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Профиль преподавателя</h3>
                        <p class="text-muted">Здесь вы можете просмотреть информацию о своем профиле.</p>
                    </div>
                </div>

                <!-- Profile Sub-tabs -->
                <ul class="nav nav-tabs mt-3" id="teacherProfileSubTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="teacher-personal-info-tab" data-bs-toggle="tab" data-bs-target="#teacher-personal-info" type="button" role="tab" aria-controls="teacher-personal-info" aria-selected="true">Личная информация</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="teacher-receipts-tab" data-bs-toggle="tab" data-bs-target="#teacher-receipts" type="button" role="tab" aria-controls="teacher-receipts" aria-selected="false">Чеки</button>
                    </li>
                </ul>

                <!-- Profile Sub-tab Content -->
                <div class="tab-content" id="teacherProfileSubTabsContent">
                    <!-- Personal Info Sub-tab -->
                    <div class="tab-pane fade show active" id="teacher-personal-info" role="tabpanel" aria-labelledby="teacher-personal-info-tab">
                        <div class="row mt-3">
                            <div class="col-md-8 mx-auto">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Личная информация</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="profileInfo">
                                            <p class="text-muted text-center">Загрузка информации о профиле...</p>
                                        </div>
                                        <div class="mt-3 text-center">
                                            <a href="/profile/edit" class="btn btn-primary">Редактировать профиль</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Receipts Sub-tab -->
                    <div class="tab-pane fade" id="teacher-receipts" role="tabpanel" aria-labelledby="teacher-receipts-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5>Чеки за мои курсы</h5>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadMyReceipts()">
                                            <i class="fas fa-sync-alt"></i> Обновить
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="receiptsList">
                                            <p class="text-muted text-center">Загрузка списка чеков...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseModalLabel">Добавить курс</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="courseForm">
                        <input type="hidden" id="courseId">
                        <div class="mb-3">
                            <label for="courseTitle" class="form-label">Название курса</label>
                            <input type="text" class="form-control" id="courseTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="courseDescription" class="form-label">Описание курса</label>
                            <textarea class="form-control" id="courseDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="coursePrice" class="form-label">Цена курса (руб.)</label>
                            <input type="number" class="form-control" id="coursePrice" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="courseImage" class="form-label">Изображение курса</label>
                            <input type="file" class="form-control" id="courseImage" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="courseCategory" class="form-label">Категория</label>
                            <select class="form-select" id="courseCategory" required>
                                <option value="">Выберите категорию</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="courseStatus" class="form-label">Статус курса</label>
                            <select class="form-select" id="courseStatus" required>
                                <option value="">Выберите статус</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveCourse()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load data for the active tab (my courses by default)
            loadMyCourses();
            loadCategories();
            loadCourseStatuses();
        });

        function loadMyCourses() {
            fetch('/v1/api/courses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(allCourses => {
                // Filter courses by current teacher
                return fetch('/v1/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                .then(response => response.json())
                .then(user => {
                    return {allCourses, user};
                });
            })
            .then(data => {
                const {allCourses, user} = data;
                const teacherCourses = allCourses.filter(course => 
                    course.teacher && course.teacher.userId === user.userId
                );
                
                const coursesList = document.getElementById('myCoursesList');
                if (teacherCourses.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">У вас пока нет курсов</p>';
                } else {
                    let html = '<div class="row">';
                    teacherCourses.forEach(course => {
                        // Add category display
                        const categoryBadge = course.category ? 
                            `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                        
                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card course-card h-100">
                                    <div class="card-body d-flex flex-column">
                                        ${course.imageUrl ? 
                                            `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                            `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>`}
                                        <h5 class="card-title">
                                            ${categoryBadge}
                                            ${course.title}
                                        </h5>
                                        <p class="card-text flex-grow-1">${course.description || 'Без описания'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">${course.price ? course.price + ' руб.' : 'Бесплатно'}</span>
                                                <span class="badge bg-success">${course.courseStatus ? course.courseStatus.statusName : 'Не указан'}</span>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="/teacher/course/${course.courseId}" class="btn btn-outline-primary">
                                                    <i class="fas fa-info-circle"></i> Подробнее
                                                </a>
                                                <button class="btn btn-warning" onclick="editCourse(${course.courseId})">
                                                    <i class="fas fa-edit"></i> Редактировать
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('myCoursesList').innerHTML = '<p class="text-danger text-center">Ошибка загрузки списка курсов</p>';
            });
        }

        function loadCategories() {
            fetch('/v1/api/categories', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('courseCategory');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.textContent = category.categoryName;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
        }

        function loadCourseStatuses() {
            fetch('/v1/api/course-statuses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(statuses => {
                const statusSelect = document.getElementById('courseStatus');
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.courseStatusId;
                    option.textContent = status.statusName;
                    statusSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading course statuses:', error);
            });
        }

        function loadMyReceipts() {
            // First get all courses taught by the teacher
            fetch('/v1/api/courses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(allCourses => {
                // Filter courses by current teacher
                return fetch('/v1/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                .then(response => response.json())
                .then(user => {
                    const teacherCourses = allCourses.filter(course => 
                        course.teacher && course.teacher.userId === user.userId
                    );
                    
                    // Get check IDs for these courses
                    const courseIds = teacherCourses.map(course => course.courseId);
                    
                    // For simplicity, we'll just show all checks for now
                    // In a real implementation, you might want to filter by course IDs
                    return fetch('/v1/api/courses/my/checks', {
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    })
                    .then(response => response.json())
                    .then(checks => {
                        // Filter checks to only show those for courses taught by this teacher
                        const teacherChecks = checks.filter(check => 
                            check.course && courseIds.includes(check.course.courseId)
                        );
                        
                        const receiptsList = document.getElementById('receiptsList');
                        if (teacherChecks.length === 0) {
                            receiptsList.innerHTML = '<p class="text-muted text-center">Пока нет чеков за ваши курсы</p>';
                        } else {
                            let html = `
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Номер чека</th>
                                                <th>Курс</th>
                                                <th>Студент</th>
                                                <th>Сумма</th>
                                                <th>Дата оплаты</th>
                                                <th>Статус</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            teacherChecks.forEach(check => {
                                html += `
                                    <tr>
                                        <td>${check.checkId || 'Не указан'}</td>
                                        <td>${check.course ? check.course.title : 'Не указан'}</td>
                                        <td>${check.user ? (check.user.firstName + ' ' + check.user.lastName) : 'Не указан'}</td>
                                        <td>${check.amount ? check.amount + ' руб.' : 'Не указана'}</td>
                                        <td>${check.paymentDate ? new Date(check.paymentDate).toLocaleDateString('ru-RU') : 'Не указана'}</td>
                                        <td>${check.paymentStatus ? check.paymentStatus.statusName : 'Не указан'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            
                            receiptsList.innerHTML = html;
                        }
                    });
                });
            })
            .catch(error => {
                document.getElementById('receiptsList').innerHTML = '<p class="text-danger text-center">Ошибка загрузки списка чеков</p>';
            });
        }

        function loadProfile() {
            fetch('/v1/api/auth/me', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(user => {
                const profileInfo = document.getElementById('profileInfo');
                profileInfo.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                ${user.imageUrl ? 
                                    `<img src="${user.imageUrl}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;" alt="Profile image">` : 
                                    `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                                        <i class="fas fa-user fa-3x text-secondary"></i>
                                    </div>`}
                                <h5 class="mt-2">${user.firstName} ${user.lastName}</h5>
                                <p class="text-muted">${user.role ? user.role.roleName : 'Преподаватель'}</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Личная информация</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Имя:</strong></td>
                                    <td>${user.firstName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Фамилия:</strong></td>
                                    <td>${user.lastName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Отчество:</strong></td>
                                    <td>${user.middleName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>${user.email || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Дата регистрации:</strong></td>
                                    <td>${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('ru-RU') : 'Не указана'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById('profileInfo').innerHTML = '<p class="text-danger text-center">Ошибка загрузки информации о профиле</p>';
            });
        }

        // Load profile when profile tab is shown
        document.getElementById('profile-tab').addEventListener('shown.bs.tab', function (e) {
            loadProfile();
        });

        // Load my courses when my courses tab is shown
        document.getElementById('my-courses-tab').addEventListener('shown.bs.tab', function (e) {
            loadMyCourses();
        });
        
        // Load receipts when receipts sub-tab is shown
        document.getElementById('teacher-receipts-tab').addEventListener('shown.bs.tab', function (e) {
            loadMyReceipts();
        });

        function showAddCourseModal() {
            // Reset form
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('courseModalLabel').textContent = 'Добавить курс';
            
            const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));
            courseModal.show();
        }

        function editCourse(courseId) {
            // Redirect to edit course page
            window.location.href = `/teacher/edit-course/${courseId}`;
        }

        function saveCourse() {
            const courseId = document.getElementById('courseId').value;
            const imageFile = document.getElementById('courseImage').files[0];
            
            if (imageFile && !courseId) {
                // Uploading a new course with an image
                uploadImage(imageFile)
                    .then(imageUrl => {
                        createCourseWithImage(imageUrl);
                    })
                    .catch(error => {
                        alert('Ошибка загрузки изображения: ' + error.message);
                    });
            } else if (courseId) {
                // Updating an existing course
                if (imageFile) {
                    // Update with new image
                    uploadImage(imageFile)
                        .then(imageUrl => {
                            updateCourseWithImage(courseId, imageUrl);
                        })
                        .catch(error => {
                            alert('Ошибка загрузки изображения: ' + error.message);
                        });
                } else {
                    // Update without changing image
                    updateCourseWithImage(courseId, null);
                }
            } else {
                // Creating a new course without an image
                createCourseWithImage(null);
            }
        }

        function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            return fetch('/v1/api/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + + localStorage.getItem('token')
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to upload image');
                }
            })
            .then(data => {
                return data.url; // Assuming the response contains the URL of the uploaded file
            });
        }

        function createCourseWithImage(imageUrl) {
            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseFloat(document.getElementById('coursePrice').value),
                category: {
                    categoryId: document.getElementById('courseCategory').value
                },
                courseStatus: {
                    courseStatusId: document.getElementById('courseStatus').value
                }
            };
            
            // Add image URL if provided
            if (imageUrl) {
                courseData.imageUrl = imageUrl;
            }

            fetch('/v1/api/courses', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(courseData)
            })
            .then(response => {
                if (response.ok) {
                    const courseModal = bootstrap.Modal.getInstance(document.getElementById('courseModal'));
                    courseModal.hide();
                    loadMyCourses();
                    alert('Курс успешно создан!');
                } else {
                    alert('Ошибка создания курса');
                }
            })
            .catch(error => {
                alert('Ошибка создания курса: ' + error.message);
            });
        }

        function updateCourseWithImage(courseId, imageUrl) {
            const courseData = {
                courseId: courseId,
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseFloat(document.getElementById('coursePrice').value),
                category: {
                    categoryId: document.getElementById('courseCategory').value
                },
                courseStatus: {
                    courseStatusId: document.getElementById('courseStatus').value
                }
            };
            
            // Add image URL if provided
            if (imageUrl) {
                courseData.imageUrl = imageUrl;
            }

            fetch(`/v1/api/courses/${courseId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(courseData)
            })
            .then(response => {
                if (response.ok) {
                    const courseModal = bootstrap.Modal.getInstance(document.getElementById('courseModal'));
                    courseModal.hide();
                    loadMyCourses();
                    alert('Курс успешно обновлен!');
                } else {
                    alert('Ошибка обновления курса');
                }
            })
            .catch(error => {
                alert('Ошибка обновления курса: ' + error.message);
            });
        }
    </script>
</body>
</html>