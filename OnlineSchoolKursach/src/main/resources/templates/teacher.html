<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è - SupSchool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom-theme.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user-settings.js"></script>
    <script src="/js/teacher-hotkeys.js"></script>
    <style>
        .teacher-card {
            transition: transform 0.2s;
        }
        .teacher-card:hover {
            transform: translateY(-5px);
        }
        .tab-content {
            min-height: 400px;
        }
        .course-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .calendar-day {
            min-height: 120px;
            border: 1px solid #dee2e6;
            padding: 10px;
            background-color: #fff;
        }
        .calendar-day.today {
            background-color: #e7f3ff;
            border: 2px solid #0d6efd;
        }
        .calendar-day-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .task-item {
            background-color: #f8f9fa;
            border-left: 3px solid #0d6efd;
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .task-item.urgent {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .task-item.warning {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }
    </style>
</head>
<body class="bg-light" data-context="teacher-dashboard">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand text-white" href="/">SupSchool - –ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3 text-white" th:if="${#authentication != null}">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span th:text="${#authentication.name}"></span>!
                </span>
                <button id="themeToggle" class="btn btn-sm btn-outline-light me-2" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    üåô
                </button>
                <a class="nav-link text-white" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="my-courses-tab" data-bs-toggle="tab" data-bs-target="#my-courses" type="button" role="tab" aria-controls="my-courses" aria-selected="true">–ú–æ–∏ –∫—É—Ä—Å—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab" aria-controls="calendar" aria-selected="false">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive" type="button" role="tab" aria-controls="archive" aria-selected="false">–ê—Ä—Ö–∏–≤</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">–ü—Ä–æ—Ñ–∏–ª—å</button>
            </li>
        </ul>

        
        <div class="tab-content" id="teacherTabsContent">
            
            <div class="tab-pane fade show active" id="my-courses" role="tabpanel" aria-labelledby="my-courses-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ú–æ–∏ –∫—É—Ä—Å—ã</h3>
                        <p class="text-muted">–ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–µ–¥–µ—Ç–µ.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                                <h5 class="mb-0">–í–∞—à–∏ –∫—É—Ä—Å—ã</h5>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <input type="text"
                                           id="teacherCourseSearch"
                                           class="form-control form-control-sm"
                                           style="min-width: 220px;"
                                           placeholder="–ü–æ–∏—Å–∫ –∫—É—Ä—Å–∞..."
                                           data-action="search">
                                    <button class="btn btn-primary btn-sm" onclick="showAddCourseModal()" data-action="create-course">
                                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="myCoursesList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∞—à–∏—Ö –∫—É—Ä—Å–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="archive" role="tabpanel" aria-labelledby="archive-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ê—Ä—Ö–∏–≤ –∫—É—Ä—Å–æ–≤</h3>
                        <p class="text-muted">–ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–∞—à–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê—Ä—Ö–∏–≤–Ω—ã–π".</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–ê—Ä—Ö–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadArchivedCourses()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="archivedCoursesList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞–Ω–∏–π</h3>
                        <p class="text-muted">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–ù–µ–¥–µ–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h5>
                                <div>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="previousWeek()">
                                        <i class="fas fa-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm mx-2" onclick="currentWeek()">
                                        <i class="fas fa-calendar-day"></i> –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="nextWeek()">
                                        –°–ª–µ–¥—É—é—â–∞—è <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="loadCalendar()">
                                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="calendarContainer">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h3>
                        <p class="text-muted">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                            </div>
                            <div class="card-body">
                                <div id="profileInfo">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ñ–∏–ª–µ...</p>
                                </div>
                                <div class="mt-3 text-center">
                                    <a href="/profile/edit" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseModalLabel">–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="courseForm">
                        <input type="hidden" id="courseId">
                        <div class="mb-3">
                            <label for="courseTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                            <input type="text" class="form-control" id="courseTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="courseDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                            <textarea class="form-control" id="courseDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="coursePrice" class="form-label">–¶–µ–Ω–∞ –∫—É—Ä—Å–∞ (—Ä—É–±.)</label>
                            <input type="number" class="form-control" id="coursePrice" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="courseImage" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                            <input type="file" class="form-control" id="courseImage" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="courseCategory" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select class="form-select" id="courseCategory" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="courseStatus" class="form-label">–°—Ç–∞—Ç—É—Å –∫—É—Ä—Å–∞</label>
                            <select class="form-select" id="courseStatus">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="courseCapacity" class="form-label">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–∫–æ–ª-–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)</label>
                                <input type="number" class="form-control" id="courseCapacity" min="1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="courseStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                <input type="date" class="form-control" id="courseStartDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="courseEndDate" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" class="form-control" id="courseEndDate" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveCourse()" data-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        let teacherCoursesCache = [];

        function authHeaders() {
            const headers = {};
            const token = localStorage.getItem('token');
            if (token) headers['Authorization'] = 'Bearer ' + token;
            return headers;
        }
        document.addEventListener('DOMContentLoaded', function() {
            setupTeacherSearch();

            loadMyCourses();

            Promise.all([
                loadCategories(),
                loadCourseStatuses()
            ]).then(() => {

                const urlParams = new URLSearchParams(window.location.search);
                const copyParam = urlParams.get('copy');
                const courseIdParam = urlParams.get('courseId');
                
                if (copyParam === 'true' && courseIdParam) {

                    fetch(`/v1/api/courses/${courseIdParam}`, {
                        headers: authHeaders()
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞');
                        }
                        return response.json();
                    })
                    .then(course => {

                        copyCourseToModal(course);

                        window.history.replaceState({}, document.title, window.location.pathname);
                    })
                    .catch(error => {
                        console.error('Error copying course:', error);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫—É—Ä—Å–∞: ' + error.message);
                    });
                }
            });
        });

        function setupTeacherSearch() {
            const searchInput = document.getElementById('teacherCourseSearch');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    applyTeacherCourseSearch();
                });
            }
        }

        function loadMyCourses() {
            fetch('/v1/api/courses/teacher/all', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(allCourses => {

                const teacherCourses = allCourses.filter(course => 
                    course.courseStatus && course.courseStatus.statusName !== '–ê—Ä—Ö–∏–≤–Ω—ã–π'
                );
                
                teacherCoursesCache = teacherCourses;
                applyTeacherCourseSearch();
            })
            .catch(error => {
                document.getElementById('myCoursesList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤</p>';
            });
        }

        function applyTeacherCourseSearch() {
            const searchInput = document.getElementById('teacherCourseSearch');
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';
            if (!teacherCoursesCache || teacherCoursesCache.length === 0) {
                renderTeacherCourses([]);
                return;
            }
            const filtered = term ? teacherCoursesCache.filter(course => 
                (course.title || '').toLowerCase().includes(term)
            ) : teacherCoursesCache.slice();
            renderTeacherCourses(filtered);
        }

        function renderTeacherCourses(courses) {
            const coursesList = document.getElementById('myCoursesList');
            if (!courses || courses.length === 0) {
                const message = (teacherCoursesCache && teacherCoursesCache.length === 0)
                    ? '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤'
                    : '–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                coursesList.innerHTML = `<p class="text-muted text-center">${message}</p>`;
                return;
            }
            let html = '<div class="row">';
            courses.forEach(course => {
                const categoryBadge = course.category ? 
                    `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card course-card h-100">
                            <div class="card-body d-flex flex-column">
                                ${course.imageUrl ? 
                                    `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                    `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>`}
                                <h5 class="card-title">
                                    ${categoryBadge}
                                    ${course.title}
                                </h5>
                                <p class="card-text flex-grow-1">${course.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-primary">${course.price ? course.price + ' —Ä—É–±.' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
                                        <span class="badge bg-success">${course.courseStatus ? course.courseStatus.statusName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <a href="/teacher/course/${course.courseId}" class="btn btn-outline-primary">
                                            <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </a>
                                        <button class="btn btn-warning" onclick="editCourse(${course.courseId})">
                                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            coursesList.innerHTML = html;
        }

        function loadArchivedCourses() {
            fetch('/v1/api/courses/teacher/all', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(allCourses => {

                const archivedCourses = allCourses.filter(course => 
                    course.courseStatus && course.courseStatus.statusName === '–ê—Ä—Ö–∏–≤–Ω—ã–π'
                );
                
                const coursesList = document.getElementById('archivedCoursesList');
                if (archivedCourses.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">–£ –≤–∞—Å –Ω–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</p>';
                } else {
                    let html = '<div class="row">';
                    archivedCourses.forEach(course => {

                        const categoryBadge = course.category ? 
                            `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                        
                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card course-card h-100" style="opacity: 0.8;">
                                    <div class="card-body d-flex flex-column">
                                        ${course.imageUrl ? 
                                            `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                            `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>`}
                                        <h5 class="card-title">
                                            ${categoryBadge}
                                            ${course.title}
                                        </h5>
                                        <p class="card-text flex-grow-1">${course.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">${course.price ? course.price + ' —Ä—É–±.' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
                                                <span class="badge bg-secondary">${course.courseStatus ? course.courseStatus.statusName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="/teacher/course/${course.courseId}" class="btn btn-outline-secondary">
                                                    <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading archived courses:', error);
                document.getElementById('archivedCoursesList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</p>';
            });
        }

        function loadCategories() {
            return fetch('/v1/api/categories', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('courseCategory');

                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.textContent = category.categoryName;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
        }

        function loadCourseStatuses() {
            return fetch('/v1/api/course-statuses', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(statuses => {
                const statusSelect = document.getElementById('courseStatus');

                while (statusSelect.options.length > 1) {
                    statusSelect.remove(1);
                }
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.courseStatusId;
                    option.textContent = status.statusName;
                    statusSelect.appendChild(option);
                });

                const recruitOption = Array.from(statusSelect.options).find(o => o.textContent === '–ò–¥–µ—Ç –Ω–∞–±–æ—Ä');
                if (recruitOption) {
                    statusSelect.value = recruitOption.value;
                }
            })
            .catch(error => {
                console.error('Error loading course statuses:', error);
            });
        }

        function loadMyReceipts() {

            fetch('/v1/api/courses', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(allCourses => {

                return fetch('/v1/api/auth/me', {
                    headers: authHeaders()
                })
                .then(response => response.json())
                .then(user => {
                    const teacherCourses = allCourses.filter(course => 
                        course.teacher && course.teacher.userId === user.userId
                    );

                    const courseIds = teacherCourses.map(course => course.courseId);


                    return fetch('/v1/api/courses/my/checks', {
                        headers: authHeaders()
                    })
                    .then(response => response.json())
                    .then(checks => {

                        const teacherChecks = checks.filter(check => 
                            check.course && courseIds.includes(check.course.courseId)
                        );
                        
                        const receiptsList = document.getElementById('receiptsList');
                        if (teacherChecks.length === 0) {
                            receiptsList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç —á–µ–∫–æ–≤ –∑–∞ –≤–∞—à–∏ –∫—É—Ä—Å—ã</p>';
                        } else {
                            let html = `
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>–ù–æ–º–µ—Ä —á–µ–∫–∞</th>
                                                <th>–ö—É—Ä—Å</th>
                                                <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                                                <th>–°—É–º–º–∞</th>
                                                <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                                                <th>–°—Ç–∞—Ç—É—Å</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            teacherChecks.forEach(check => {
                                html += `
                                    <tr>
                                        <td>${check.checkId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                        <td>${check.course ? check.course.title : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                        <td>${check.user ? (check.user.firstName + ' ' + check.user.lastName) : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                        <td>${check.amount ? check.amount + ' —Ä—É–±.' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                        <td>${check.paymentDate ? new Date(check.paymentDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                        <td>${check.paymentStatus ? check.paymentStatus.statusName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            
                            receiptsList.innerHTML = html;
                        }
                    });
                });
            })
            .catch(error => {
                document.getElementById('receiptsList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —á–µ–∫–æ–≤</p>';
            });
        }

        function loadProfile() {
            fetch('/v1/api/auth/me', {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(user => {
                const profileInfo = document.getElementById('profileInfo');
                profileInfo.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                ${user.imageUrl ? 
                                    `<img src="${user.imageUrl}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;" alt="Profile image">` : 
                                    `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                                        <i class="fas fa-user fa-3x text-secondary"></i>
                                    </div>`}
                                <h5 class="mt-2">${user.firstName} ${user.lastName}</h5>
                                <p class="text-muted">${user.role ? user.role.roleName : '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å'}</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>–ò–º—è:</strong></td>
                                    <td>${user.firstName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                </tr>
                                <tr>
                                    <td><strong>–§–∞–º–∏–ª–∏—è:</strong></td>
                                    <td>${user.lastName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                </tr>
                                <tr>
                                    <td><strong>–û—Ç—á–µ—Å—Ç–≤–æ:</strong></td>
                                    <td>${user.middleName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                </tr>
                                <tr>
                                    <td><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong></td>
                                    <td>${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById('profileInfo').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ñ–∏–ª–µ</p>';
            });
        }

        document.getElementById('profile-tab').addEventListener('shown.bs.tab', function (e) {
            loadProfile();
        });

        document.getElementById('my-courses-tab').addEventListener('shown.bs.tab', function (e) {
            loadMyCourses();
        });

        document.getElementById('calendar-tab').addEventListener('shown.bs.tab', function (e) {
            loadCalendar();
        });

        document.getElementById('archive-tab').addEventListener('shown.bs.tab', function (e) {
            loadArchivedCourses();
        });

        document.getElementById('teacher-receipts-tab').addEventListener('shown.bs.tab', function (e) {
            loadMyReceipts();
        });

        function showAddCourseModal() {

            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('courseModalLabel').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å';
            
            const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));
            courseModal.show();
        }

        function copyCourseToModal(course) {
            if (!course) {
                console.error('Course data is null');
                return;
            }

            document.getElementById('courseId').value = '';
            document.getElementById('courseModalLabel').textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é –∫—É—Ä—Å–∞';

            document.getElementById('courseTitle').value = (course.title || '') + ' (–∫–æ–ø–∏—è)';
            document.getElementById('courseDescription').value = course.description || '';
            document.getElementById('coursePrice').value = course.price || 0;

            if (course.category && course.category.categoryId) {
                document.getElementById('courseCategory').value = course.category.categoryId;
            }

            document.getElementById('courseStatus').value = '';

            if (course.capacity) {
                document.getElementById('courseCapacity').value = course.capacity;
            }

            document.getElementById('courseStartDate').value = '';
            document.getElementById('courseEndDate').value = '';



            const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));
            courseModal.show();
        }
        

        function editCourse(courseId) {

            window.location.href = `/teacher/edit-course/${courseId}`;
        }

        function saveCourse() {
            const courseId = document.getElementById('courseId').value;
            const imageFile = document.getElementById('courseImage').files[0];
            
            if (imageFile && !courseId) {

                uploadImage(imageFile)
                    .then(imageUrl => {
                        createCourseWithImage(imageUrl);
                    })
                    .catch(error => {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                    });
            } else if (courseId) {

                if (imageFile) {

                    uploadImage(imageFile)
                        .then(imageUrl => {
                            updateCourseWithImage(courseId, imageUrl);
                        })
                        .catch(error => {
                            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                        });
                } else {

                    updateCourseWithImage(courseId, null);
                }
            } else {

                createCourseWithImage(null);
            }
        }

        function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            return fetch('/v1/api/files/upload', {
                method: 'POST',
                headers: authHeaders(),
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to upload image');
                }
            })
            .then(data => {
                return data.url; // Assuming the response contains the URL of the uploaded file
            });
        }

        function createCourseWithImage(imageUrl) {
            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseFloat(document.getElementById('coursePrice').value),
                category: {
                    categoryId: document.getElementById('courseCategory').value
                },
                courseStatus: {
                    courseStatusId: document.getElementById('courseStatus').value || null
                },
                capacity: document.getElementById('courseCapacity').value ? parseInt(document.getElementById('courseCapacity').value) : null,
                startDate: document.getElementById('courseStartDate').value || null,
                endDate: document.getElementById('courseEndDate').value || null
            };

            if (imageUrl) {
                courseData.imageUrl = imageUrl;
            }

            fetch('/v1/api/courses', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
                body: JSON.stringify(courseData)
            })
            .then(response => {
                if (response.ok) {
                    const courseModal = bootstrap.Modal.getInstance(document.getElementById('courseModal'));
                    courseModal.hide();
                    loadMyCourses();
                    alert('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞');
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞: ' + error.message);
            });
        }

        function updateCourseWithImage(courseId, imageUrl) {
            const courseData = {
                courseId: courseId,
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseFloat(document.getElementById('coursePrice').value),
                category: {
                    categoryId: document.getElementById('courseCategory').value
                },
                courseStatus: {
                    courseStatusId: document.getElementById('courseStatus').value
                },
                capacity: document.getElementById('courseCapacity').value ? parseInt(document.getElementById('courseCapacity').value) : null,
                startDate: document.getElementById('courseStartDate').value || null,
                endDate: document.getElementById('courseEndDate').value || null
            };

            if (imageUrl) {
                courseData.imageUrl = imageUrl;
            }

            fetch(`/v1/api/courses/${courseId}`, {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
                body: JSON.stringify(courseData)
            })
            .then(response => {
                if (response.ok) {
                    const courseModal = bootstrap.Modal.getInstance(document.getElementById('courseModal'));
                    courseModal.hide();
                    loadMyCourses();
                    alert('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞');
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞: ' + error.message);
            });
        }

        let currentWeekStart = null;

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            return date.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function currentWeek() {
            currentWeekStart = getWeekStart(new Date());
            loadCalendar();
        }

        function previousWeek() {
            if (!currentWeekStart) {
                currentWeekStart = getWeekStart(new Date());
            }
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadCalendar();
        }

        function nextWeek() {
            if (!currentWeekStart) {
                currentWeekStart = getWeekStart(new Date());
            }
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadCalendar();
        }

        function loadCalendar() {
            if (!currentWeekStart) {
                currentWeekStart = getWeekStart(new Date());
            }
            
            const weekStartStr = formatDate(currentWeekStart);
            const calendarContainer = document.getElementById('calendarContainer');
            calendarContainer.innerHTML = '<p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>';

            fetch(`/v1/api/tasks/teacher/calendar?weekStart=${weekStartStr}`, {
                headers: authHeaders()
            })
            .then(response => response.json())
            .then(tasks => {
                renderCalendar(tasks);
            })
            .catch(error => {
                console.error('Error loading calendar:', error);
                calendarContainer.innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</p>';
            });
        }

        function renderCalendar(tasks) {
            const calendarContainer = document.getElementById('calendarContainer');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekStart = new Date(currentWeekStart);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            let html = `
                <div class="mb-3">
                    <h5>–ù–µ–¥–µ–ª—è: ${formatDateDisplay(weekStart)} - ${formatDateDisplay(weekEnd)}</h5>
                </div>
                <div class="row g-2">
            `;
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);
                
                const dayStr = formatDate(dayDate);
                const dayTasks = tasks.filter(task => {
                    if (!task.deadline) return false;
                    const taskDate = new Date(task.deadline);
                    taskDate.setHours(0, 0, 0, 0);
                    return taskDate.getTime() === dayDate.getTime();
                });
                
                const isToday = dayDate.getTime() === today.getTime();
                const dayClass = isToday ? 'calendar-day today' : 'calendar-day';
                
                html += `
                    <div class="col-md">
                        <div class="${dayClass}">
                            <div class="calendar-day-header">
                                ${formatDateDisplay(dayDate)}
                            </div>
                            <div class="task-list">
                `;
                
                if (dayTasks.length === 0) {
                    html += '<p class="text-muted small">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</p>';
                } else {
                    dayTasks.forEach(task => {
                        const taskDate = new Date(task.deadline);
                        const daysUntilDeadline = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
                        let taskClass = 'task-item';
                        
                        if (daysUntilDeadline < 0) {
                            taskClass += ' urgent';
                        } else if (daysUntilDeadline <= 2) {
                            taskClass += ' warning';
                        }
                        
                        const courseName = task.lesson && task.lesson.course ? task.lesson.course.title : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫—É—Ä—Å';
                        const lessonName = task.lesson ? task.lesson.title : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—Ä–æ–∫';
                        const courseId = task.lesson && task.lesson.course ? task.lesson.course.courseId : 0;
                        const lessonId = task.lesson ? task.lesson.lessonId : 0;
                        
                        if (courseId && lessonId) {
                            html += `
                                <div class="${taskClass}" onclick="viewTask(${courseId}, ${lessonId}, ${task.taskId})" title="${task.description || ''}">
                                    <strong>${task.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>
                                    <small class="text-muted">${courseName}</small><br>
                                    <small class="text-muted">${lessonName}</small>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="${taskClass}" title="${task.description || ''}">
                                    <strong>${task.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>
                                    <small class="text-muted">${courseName}</small><br>
                                    <small class="text-muted">${lessonName}</small>
                                </div>
                            `;
                        }
                    });
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            calendarContainer.innerHTML = html;
        }

        function viewTask(courseId, lessonId, taskId) {
            window.location.href = `/teacher/course/${courseId}/lesson/${lessonId}/task/${taskId}`;
        }
    </script>
</body>
</html>