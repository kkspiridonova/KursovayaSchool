<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${'–†–µ—à–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ - ' + task.title + ' - SupSchool'}">–†–µ—à–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ - SupSchool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom-theme.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user-settings.js"></script>
    <script src="/js/teacher-hotkeys.js"></script>
    <style>
        .solution-header {
            position: relative;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .solution-title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0;
            text-align: center;
        }
        
        .grade-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body data-context="teacher-solution"
      th:data-course-id="${course.courseId}"
      th:data-lesson-id="${lesson.lessonId}"
      th:data-task-id="${task.taskId}"
      th:data-solution-id="${solution.solutionId}">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand text-white" href="/">SupSchool</a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3" th:if="${#authentication != null}">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span th:text="${#authentication.name}"></span>!
                </span>
                <button id="themeToggle" class="btn btn-sm btn-outline-light me-2" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    üåô
                </button>
                <a class="nav-link text-white" th:href="@{/teacher/course/{courseId}/lesson/{lessonId}/task/{taskId}(courseId=${course.courseId}, lessonId=${lesson.lessonId}, taskId=${task.taskId})}">–ù–∞–∑–∞–¥ –∫ –∑–∞–¥–∞–Ω–∏—é</a>
                <a class="nav-link text-white" th:href="@{/teacher/course/{courseId}/lesson/{lessonId}(courseId=${course.courseId}, lessonId=${lesson.lessonId})}">–ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫—É</a>
                <a class="nav-link text-white" th:href="@{/teacher/course/{courseId}(courseId=${course.courseId})}">–ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É</a>
                <a class="nav-link text-white" href="/teacher">–ú–æ–∏ –∫—É—Ä—Å—ã</a>
                <a class="nav-link text-white" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    
    <div class="solution-header">
        <h1 class="solution-title">–†–µ—à–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</h1>
    </div>

    <div class="container">
        <div class="row">
            
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—à–µ–Ω–∏–∏</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>–°—Ç—É–¥–µ–Ω—Ç</h5>
                                <p th:text="${student.firstName + ' ' + student.lastName}">–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞</p>
                            </div>
                            <div class="col-md-6">
                                <h5>–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
                                <p id="submitDateValue" th:text="${#temporals.format(solution.submitDate, 'dd.MM.yyyy HH:mm')}">–¥–¥.–º–º.–≥–≥–≥–≥ —á—á:–º–º</p>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h5>–°—Ç–∞—Ç—É—Å —Ä–µ—à–µ–Ω–∏—è</h5>
                                <p>
                                    <span th:if="${solution.solutionStatus.statusName == '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'}" class="badge bg-warning">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                    <span th:if="${solution.solutionStatus.statusName == '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'}" class="badge bg-info">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                    <span th:if="${solution.solutionStatus.statusName == '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ'}" class="badge bg-success">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h5>–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞</h5>
                                <p id="currentGradeValue" th:text="${solution.grade != null ? solution.grade.gradeValue : '‚Äî'}">–û—Ü–µ–Ω–∫–∞</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${solution.answerText}">
                            <h5>–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:</h5>
                            <p th:text="${solution.answerText}">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</p>
                        </div>
                        <div th:if="${solution.answerText == null}" class="text-muted">
                            –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        </div>
                        
                        <div th:if="${solution.answerFile}" class="mt-3">
                            <h5>–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞:</h5>
                            <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(solution.answerFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –æ—Ç–≤–µ—Ç–∞
                            </a>
                        </div>
                        <div th:if="${solution.answerFile == null}" class="mt-3 text-muted">
                            –§–∞–π–ª –æ—Ç–≤–µ—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>–ö—É—Ä—Å:</strong>
                                <span class="text-muted" th:text="${course.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–£—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${lesson.title}">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ó–∞–¥–∞–Ω–∏–µ:</strong>
                                <span class="text-muted" th:text="${task.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${#temporals.format(task.deadline, 'dd.MM.yyyy')}">–¥–¥.–º–º.–≥–≥–≥–≥</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                
                <div class="card">
                    <div class="card-header">
                        <h5>–û—Ü–µ–Ω–∫–∞ —Ä–µ—à–µ–Ω–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <form id="gradeForm" class="grade-form">
                            <div class="mb-3">
                                <label for="gradeValue" class="form-label">–û—Ü–µ–Ω–∫–∞</label>
                                <select class="form-select" id="gradeValue" 
                                        th:disabled="${solution.grade != null}">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</option>
                                    <option value="0" th:selected="${solution.grade != null && solution.grade.gradeValue == 0}">0 - –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                                    <option value="1" th:selected="${solution.grade != null && solution.grade.gradeValue == 1}">1 - –û—á–µ–Ω—å –ø–ª–æ—Ö–æ</option>
                                    <option value="2" th:selected="${solution.grade != null && solution.grade.gradeValue == 2}">2 - –ü–ª–æ—Ö–æ</option>
                                    <option value="3" th:selected="${solution.grade != null && solution.grade.gradeValue == 3}">3 - –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                                    <option value="4" th:selected="${solution.grade != null && solution.grade.gradeValue == 4}">4 - –•–æ—Ä–æ—à–æ</option>
                                    <option value="5" th:selected="${solution.grade != null && solution.grade.gradeValue == 5}">5 - –û—Ç–ª–∏—á–Ω–æ</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="feedback" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                <textarea class="form-control" id="feedback" rows="4" 
                                          th:text="${solution.grade != null ? solution.grade.feedback : ''}" 
                                          th:disabled="${solution.grade != null}"
                                          placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ"></textarea>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="submitGrade()"
                                    th:disabled="${solution.grade != null}">
                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script th:inline="javascript">
        function submitGrade() {
            const gradeValue = document.getElementById('gradeValue').value;
            const feedback = document.getElementById('feedback').value;
            const solutionId = /*[[${solution.solutionId}]]*/ '1';
            
            if (!gradeValue || gradeValue < 0 || gradeValue > 5) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 0 –¥–æ 5');
                return;
            }

            const grade = {
                gradeValue: parseInt(gradeValue),
                feedback: feedback,
                solution: { solutionId: parseInt(solutionId) }
            };

            fetch('/v1/api/grades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(grade)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to submit grade');
                }
            })
            .then(data => {

                alert('–û—Ü–µ–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');

                if (data.gradeValue !== undefined && data.gradeValue !== null) {
                    const gradeSelect = document.getElementById('gradeValue');
                    if (gradeSelect) {
                        gradeSelect.value = data.gradeValue;
                }
                    const currentGradeValue = document.getElementById('currentGradeValue');
                    if (currentGradeValue) {
                        currentGradeValue.textContent = data.gradeValue;
                    }
                }

                const gradeSelect = document.getElementById('gradeValue');
                const feedbackInput = document.getElementById('feedback');
                const saveBtn = document.querySelector('#gradeForm button[type="button"]');
                if (gradeSelect) gradeSelect.disabled = true;
                if (feedbackInput) feedbackInput.disabled = true;
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-lock"></i> –û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ' + error.message);
            });
        }
    </script>
</body>
</html>