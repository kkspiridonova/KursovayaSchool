<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${'Решение студента - ' + task.title + ' - Онлайн Школа'}">Решение студента - Онлайн Школа</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .solution-header {
            position: relative;
            height: 300px;
            overflow: hidden;
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .solution-title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0;
            text-align: center;
        }
        
        .grade-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand" href="/">Онлайн Школа</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" th:if="${#authentication != null}">
                    Добро пожаловать, <span th:text="${#authentication.name}"></span>!
                </span>
                <a class="nav-link" th:href="@{/teacher/course/{courseId}/lesson/{lessonId}/task/{taskId}(courseId=${course.courseId}, lessonId=${lesson.lessonId}, taskId=${task.taskId})}">Назад к заданию</a>
                <a class="nav-link" th:href="@{/teacher/course/{courseId}/lesson/{lessonId}(courseId=${course.courseId}, lessonId=${lesson.lessonId})}">Назад к уроку</a>
                <a class="nav-link" th:href="@{/teacher/course/{courseId}(courseId=${course.courseId})}">Назад к курсу</a>
                <a class="nav-link" href="/teacher">Мои курсы</a>
                <a class="nav-link" href="/logout">Выйти</a>
            </div>
        </div>
    </nav>

    <!-- ======= ГЛАВНЫЙ БЛОК С НАЗВАНИЕМ РЕШЕНИЯ ======= -->
    <div class="solution-header">
        <h1 class="solution-title">Решение студента</h1>
    </div>

    <div class="container">
        <div class="row">
            <!-- Solution Details -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Информация о решении</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Студент</h5>
                                <p th:text="${student.firstName + ' ' + student.lastName}">Имя студента</p>
                            </div>
                            <div class="col-md-6">
                                <h5>Дата отправки</h5>
                                <p id="submitDateValue" th:text="${#temporals.format(solution.submitDate, 'dd.MM.yyyy HH:mm')}">дд.мм.гггг чч:мм</p>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h5>Статус решения</h5>
                                <p>
                                    <span th:if="${solution.solutionStatus.statusName == 'Отправлено'}" class="badge bg-warning">Отправлено</span>
                                    <span th:if="${solution.solutionStatus.statusName == 'На проверке'}" class="badge bg-info">На проверке</span>
                                    <span th:if="${solution.solutionStatus.statusName == 'Проверено'}" class="badge bg-success">Проверено</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h5>Текущая оценка</h5>
                                <p id="currentGradeValue" th:text="${solution.grade != null ? solution.grade.gradeValue : '—'}">Оценка</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Ответ студента</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${solution.answerText}">
                            <h5>Текст ответа:</h5>
                            <p th:text="${solution.answerText}">Текст ответа</p>
                        </div>
                        <div th:if="${solution.answerText == null}" class="text-muted">
                            Текст ответа отсутствует
                        </div>
                        
                        <div th:if="${solution.answerFile}" class="mt-3">
                            <h5>Файл ответа:</h5>
                            <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(solution.answerFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                <i class="fas fa-download"></i> Скачать файл ответа
                            </a>
                        </div>
                        <div th:if="${solution.answerFile == null}" class="mt-3 text-muted">
                            Файл ответа отсутствует
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Информация о задании</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>Курс:</strong>
                                <span class="text-muted" th:text="${course.title}">Название курса</span>
                            </li>
                            <li class="mb-2">
                                <strong>Урок:</strong>
                                <span class="text-muted" th:text="${lesson.title}">Название урока</span>
                            </li>
                            <li class="mb-2">
                                <strong>Задание:</strong>
                                <span class="text-muted" th:text="${task.title}">Название задания</span>
                            </li>
                            <li class="mb-2">
                                <strong>Крайний срок:</strong>
                                <span class="text-muted" th:text="${#temporals.format(task.deadline, 'dd.MM.yyyy')}">дд.мм.гггг</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Grade Form -->
                <div class="card">
                    <div class="card-header">
                        <h5>Оценка решения</h5>
                    </div>
                    <div class="card-body">
                        <form id="gradeForm" class="grade-form">
                            <div class="mb-3">
                                <label for="gradeValue" class="form-label">Оценка</label>
                                <select class="form-select" id="gradeValue" 
                                        th:disabled="${solution.grade != null}">
                                    <option value="">Выберите оценку</option>
                                    <option value="0" th:selected="${solution.grade != null && solution.grade.gradeValue == 0}">0 - Неудовлетворительно</option>
                                    <option value="1" th:selected="${solution.grade != null && solution.grade.gradeValue == 1}">1 - Очень плохо</option>
                                    <option value="2" th:selected="${solution.grade != null && solution.grade.gradeValue == 2}">2 - Плохо</option>
                                    <option value="3" th:selected="${solution.grade != null && solution.grade.gradeValue == 3}">3 - Удовлетворительно</option>
                                    <option value="4" th:selected="${solution.grade != null && solution.grade.gradeValue == 4}">4 - Хорошо</option>
                                    <option value="5" th:selected="${solution.grade != null && solution.grade.gradeValue == 5}">5 - Отлично</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="feedback" class="form-label">Комментарий</label>
                                <textarea class="form-control" id="feedback" rows="4" 
                                          th:text="${solution.grade != null ? solution.grade.feedback : ''}" 
                                          th:disabled="${solution.grade != null}"
                                          placeholder="Оставьте комментарий к оценке"></textarea>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="submitGrade()"
                                    th:disabled="${solution.grade != null}">
                                <i class="fas fa-save"></i> Сохранить оценку
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script th:inline="javascript">
        function submitGrade() {
            const gradeValue = document.getElementById('gradeValue').value;
            const feedback = document.getElementById('feedback').value;
            const solutionId = /*[[${solution.solutionId}]]*/ '1';
            
            if (!gradeValue || gradeValue < 0 || gradeValue > 5) {
                alert('Пожалуйста, выберите оценку от 0 до 5');
                return;
            }
            
            // Create grade object
            const grade = {
                gradeValue: parseInt(gradeValue),
                feedback: feedback,
                solution: { solutionId: parseInt(solutionId) }
            };
            
            // Send data to server
            fetch('/v1/api/grades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(grade)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to submit grade');
                }
            })
            .then(data => {
                // Show success message
                alert('Оценка успешно сохранена!');
                
                // Update UI to show the new grade without reloading the page
                if (data.gradeValue !== undefined && data.gradeValue !== null) {
                    const gradeSelect = document.getElementById('gradeValue');
                    if (gradeSelect) {
                        gradeSelect.value = data.gradeValue;
                }
                    const currentGradeValue = document.getElementById('currentGradeValue');
                    if (currentGradeValue) {
                        currentGradeValue.textContent = data.gradeValue;
                    }
                }
                
                // Заблокировать дальнейшее редактирование после сохранения
                const gradeSelect = document.getElementById('gradeValue');
                const feedbackInput = document.getElementById('feedback');
                const saveBtn = document.querySelector('#gradeForm button[type="button"]');
                if (gradeSelect) gradeSelect.disabled = true;
                if (feedbackInput) feedbackInput.disabled = true;
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-lock"></i> Оценка сохранена';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при сохранении оценки: ' + error.message);
            });
        }
    </script>
</body>
</html>