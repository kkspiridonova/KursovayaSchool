<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${task.title + ' - ' + lesson.title + ' - Онлайн Школа'}">Задание - Онлайн Школа</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-header {
            position: relative;
            height: 300px;
            overflow: hidden;
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .task-title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0;
            text-align: center;
        }
        
        .solution-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand" href="/">Онлайн Школа</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" th:if="${#authentication != null}">
                    Добро пожаловать, <span th:text="${#authentication.name}"></span>!
                </span>
                <a class="nav-link" th:href="@{/student/course/{courseId}/lesson/{lessonId}(courseId=${course.courseId}, lessonId=${lesson.lessonId})}">Назад к уроку</a>
                <a class="nav-link" th:href="@{/student/course/{courseId}(courseId=${course.courseId})}">Назад к курсу</a>
                <a class="nav-link" href="/student">Мои курсы</a>
                <a class="nav-link" href="/logout">Выйти</a>
            </div>
        </div>
    </nav>

    <!-- ======= ГЛАВНЫЙ БЛОК С НАЗВАНИЕМ ЗАДАНИЯ ======= -->
    <div class="task-header">
        <h1 class="task-title" th:text="${task.title}">Название задания</h1>
    </div>

    <div class="container">
        <div class="row">
            <!-- Task Details -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Описание задания</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.description}" th:utext="${task.description}">Описание задания</div>
                        <div th:if="${task.description == null}" class="text-muted">Описание отсутствует</div>
                    </div>
                </div>
                
                <!-- Attached Materials -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Материалы задания</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.attachedFile != null && !task.attachedFile.isEmpty()}">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-pdf fa-2x me-3 text-danger"></i>
                                <div>
                                    <h5>Файл задания</h5>
                                    <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(task.attachedFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                        <i class="fas fa-download"></i> Скачать файл задания
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div th:if="${task.attachedFile == null || task.attachedFile.isEmpty()}" class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>Материалы к заданию не прикреплены
                        </div>
                    </div>
                </div>
                
                <!-- Submitted Solution (read-only) -->
                <div class="card mb-4" id="submittedSolutionCard" th:if="${solution != null}">
                    <div class="card-header">
                        <h3>Ваше решение</h3>
                    </div>
                    <div class="card-body" id="submittedSolutionCardBody">
                        <div class="mb-3">
                            <label class="form-label">Статус</label>
                            <input type="text" class="form-control" th:value="${solution.solutionStatus.statusName}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Текст ответа</label>
                            <textarea class="form-control" rows="6" th:text="${solution.answerText}" readonly></textarea>
                        </div>
                        <div class="mb-3" th:if="${solution.answerFile}">
                            <label class="form-label">Файл ответа</label>
                            <div>
                                <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(solution.answerFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-download"></i> Скачать файл ответа
                                </a>
                            </div>
                        </div>
                        <div class="mb-3" th:if="${solution.grade != null}">
                            <label class="form-label">Оценка</label>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success fs-6" th:text="${solution.grade.gradeValue}">5</span>
                                <span class="text-muted" th:if="${solution.grade.feedback}" th:text="${solution.grade.feedback}">Комментарий</span>
                            </div>
                        </div>
                        <div class="alert alert-info">Поля решения защищены от редактирования после отправки.</div>
                    </div>
                </div>

                <!-- Solution Submission -->
                <div class="card mb-4" id="submissionCard" th:if="${solution == null}">
                    <div class="card-header">
                        <h3>Отправка решения</h3>
                    </div>
                    <div class="card-body">
                        <form id="solutionForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="answerText" class="form-label">Текст ответа</label>
                                    <textarea class="form-control" id="answerText" rows="5" placeholder="Введите ваш ответ здесь..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="answerFile" class="form-label">Файл с решением</label>
                                    <input class="form-control" type="file" id="answerFile">
                                    <div class="form-text">Вы можете прикрепить файл с решением (необязательно)</div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="submitSolution()">
                                    <i class="fas fa-paper-plane"></i> Отправить решение
                                </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Информация о задании</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>Курс:</strong>
                                <span class="text-muted" th:text="${course.title}">Название курса</span>
                            </li>
                            <li class="mb-2">
                                <strong>Урок:</strong>
                                <span class="text-muted" th:text="${lesson.title}">Название урока</span>
                            </li>
                            <li class="mb-2">
                                <strong>Задание:</strong>
                                <span class="text-muted" th:text="${task.title}">Название задания</span>
                            </li>
                            <li class="mb-2">
                                <strong>Крайний срок:</strong>
                                <span class="text-muted" th:text="${#temporals.format(task.deadline, 'dd.MM.yyyy')}">дд.мм.гггг</span>
                            </li>
                            <li class="mb-2" th:if="${task.taskStatus != null}">
                                <strong>Статус:</strong>
                                <span class="text-muted" th:text="${task.taskStatus.statusName}">Статус задания</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="card" th:if="${solution != null}">
                    <div class="card-header">
                        <h5>Статус решения</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div th:if="${solution.solutionStatus.statusName == 'Сдано'}">
                                <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                                <h5 class="text-success">Сдано</h5>
                                <p class="text-muted">Ваше решение сдано вовремя</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == 'Сдано с опозданием'}">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-2"></i>
                                <h5 class="text-warning">Сдано с опозданием</h5>
                                <p class="text-muted">Ваше решение сдано после дедлайна</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == 'Просрочено'}">
                                <i class="fas fa-times-circle fa-3x text-danger mb-2"></i>
                                <h5 class="text-danger">Просрочено</h5>
                                <p class="text-muted">Дедлайн прошел, решение не сдано</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == 'Назначено'}">
                                <i class="fas fa-clock fa-3x text-secondary mb-2"></i>
                                <h5 class="text-secondary">Назначено</h5>
                                <p class="text-muted">Задание назначено, решение еще не отправлено</p>
                            </div>
                            <div th:if="${solution.grade != null}" class="mt-3">
                                <span class="badge bg-success fs-6">Оценка: <span th:text="${solution.grade.gradeValue}">5</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script th:inline="javascript">
        function submitSolution() {
            const answerText = document.getElementById('answerText').value;
            const answerFileInput = document.getElementById('answerFile');
            const answerFile = answerFileInput.files[0];
            
            // Add task and user information (these would come from server-side variables)
            const taskId = [[${task.taskId}]];
            
            // First, upload the file if it exists
            if (answerFile) {
                const fileFormData = new FormData();
                fileFormData.append('file', answerFile);
                
                fetch('/v1/api/files/upload-solution', {
                    method: 'POST',
                    credentials: 'include', // Include session cookies
                    body: fileFormData
                    // Note: Don't set Content-Type header when using FormData
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to upload file');
                    }
                })
                .then(fileData => {
                    // Create solution object with file path from MinIO
                    const solution = {
                        answerText: answerText,
                        answerFile: fileData.filePath, // Use filePath from MinIO
                        task: { taskId: taskId }
                    };
                    
                    // Submit solution data
                    return submitSolutionData(solution);
                })
                .catch(error => {
                    console.error('File upload error:', error);
                    alert('Ошибка при загрузке файла: ' + error.message);
                });
            } else {
                // No file to upload, create solution object without file
                const solution = {
                    answerText: answerText,
                    task: { taskId: taskId }
                };
                
                // Submit solution data directly
                submitSolutionData(solution);
            }
        }
        
        function submitSolutionData(solution) {
            // Send solution data to server
            fetch('/v1/api/solutions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Include session cookies
                body: JSON.stringify(solution)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // Try to get error message from response
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to submit solution');
                    });
                }
            })
            .then(data => {
                // Show success message with actual status from server
                const statusName = data.solutionStatus?.statusName || 'Сдано';
                let statusText = 'Сдано';
                let alertClass = 'alert-success';
                
                if (statusName === 'Сдано с опозданием') {
                    statusText = 'Сдано с опозданием';
                    alertClass = 'alert-warning';
                } else if (statusName === 'Сдано') {
                    statusText = 'Сдано';
                    alertClass = 'alert-success';
                } else if (statusName === 'Просрочено') {
                    statusText = 'Просрочено';
                    alertClass = 'alert-danger';
                } else if (statusName === 'Назначено') {
                    statusText = 'Назначено';
                    alertClass = 'alert-secondary';
                }
                
                alert('Решение успешно отправлено! Статус: ' + statusText);
                
                // Render read-only solution without reload
                renderSubmittedSolution(data);
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = 'Ошибка при отправке решения';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            });
        }
        
        function renderSubmittedSolution(data) {
            // Hide submission card
            const submissionCard = document.getElementById('submissionCard');
            if (submissionCard) {
                submissionCard.remove();
            }
            // Ensure submitted solution card exists
            let submittedCard = document.getElementById('submittedSolutionCard');
            if (!submittedCard) {
                submittedCard = document.createElement('div');
                submittedCard.className = 'card mb-4';
                submittedCard.id = 'submittedSolutionCard';
                submittedCard.innerHTML = `
                    <div class="card-header"><h3>Ваше решение</h3></div>
                    <div class="card-body" id="submittedSolutionCardBody"></div>
                `;
                // Insert before sidebar (in main column)
                const mainCol = document.querySelector('.col-md-8');
                mainCol.appendChild(submittedCard);
            }
            const body = document.getElementById('submittedSolutionCardBody');
            body.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Статус</label>
                    <input type="text" class="form-control" value="${(data.solutionStatus && data.solutionStatus.statusName) ? data.solutionStatus.statusName : ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Текст ответа</label>
                    <textarea class="form-control" rows="6" readonly>${(data.answerText || '').replace(/</g, '&lt;')}</textarea>
                </div>
                ${data.answerFile ? `
                <div class="mb-3">
                    <label class="form-label">Файл ответа</label>
                    <div>
                        <a class="btn btn-outline-primary" href="/v1/api/files/download?path=${encodeURIComponent(data.answerFile)}" target="_blank">
                            <i class="fas fa-download"></i> Скачать файл ответа
                        </a>
                    </div>
                </div>` : ``}
                ${data.grade ? `
                <div class="mb-3">
                    <label class="form-label">Оценка</label>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success fs-6">${data.grade.gradeValue}</span>
                        ${data.grade.feedback ? `<span class="text-muted">${data.grade.feedback}</span>` : ``}
                    </div>
                </div>` : ``}
                <div class="alert alert-info">Поля решения защищены от редактирования после отправки.</div>
            `;
        }
    </script>
</body>
</html>