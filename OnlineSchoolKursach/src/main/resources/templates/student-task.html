<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${task.title + ' - ' + lesson.title + ' - SupSchool'}">–ó–∞–¥–∞–Ω–∏–µ - SupSchool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom-theme.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user-settings.js"></script>
    <script src="/js/teacher-hotkeys.js"></script>
    <style>
        .task-header {
            position: relative;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .task-title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0;
            text-align: center;
        }
        
        .solution-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .comment-item {
            transition: transform 0.2s;
        }
        
        .comment-item:hover {
            transform: translateX(5px);
        }
        
        .comment-item .card {
            border-left: 3px solid #0d6efd;
        }
        
        .comment-item[style*="margin-left: 30px"] .card {
            border-left-color: #6c757d;
        }
        
        .comment-item[style*="margin-left: 60px"] .card {
            border-left-color: #adb5bd;
        }
    </style>
</head>
<body data-context="student-task">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand text-white" href="/">SupSchool</a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3 text-white" th:if="${#authentication != null}">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span th:text="${#authentication.name}"></span>!
                </span>
                <button id="themeToggle" class="btn btn-sm btn-outline-light me-2" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    üåô
                </button>
                <a class="nav-link text-white" th:href="@{/student/course/{courseId}/lesson/{lessonId}(courseId=${course.courseId}, lessonId=${lesson.lessonId})}">–ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫—É</a>
                <a class="nav-link text-white" th:href="@{/student/course/{courseId}(courseId=${course.courseId})}">–ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É</a>
                <a class="nav-link text-white" href="/student">–ú–æ–∏ –∫—É—Ä—Å—ã</a>
                <a class="nav-link text-white" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    
    <div class="task-header">
        <h1 class="task-title" th:text="${task.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>
    </div>

    <div class="container">
        <div class="row">
            
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.description}" th:utext="${task.description}">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
                        <div th:if="${task.description == null}" class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
                    </div>
                </div>
                
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∑–∞–¥–∞–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.attachedFile != null && !task.attachedFile.isEmpty()}">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-pdf fa-2x me-3 text-danger"></i>
                            <div>
                                <h5>–§–∞–π–ª –∑–∞–¥–∞–Ω–∏—è</h5>
                                    <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(task.attachedFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∑–∞–¥–∞–Ω–∏—è
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div th:if="${task.attachedFile == null || task.attachedFile.isEmpty()}" class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫ –∑–∞–¥–∞–Ω–∏—é –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã
                        </div>
                    </div>
                </div>
                
                
                <div class="card mb-4" id="submittedSolutionCard" th:if="${solution != null}">
                    <div class="card-header">
                        <h3>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ</h3>
                    </div>
                    <div class="card-body" id="submittedSolutionCardBody">
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <input type="text" class="form-control" th:value="${solution.solutionStatus.statusName}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</label>
                            <textarea class="form-control" rows="6" th:text="${solution.answerText}" readonly></textarea>
                        </div>
                        <div class="mb-3" th:if="${solution.answerFile}">
                            <label class="form-label">–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞</label>
                            <div>
                                <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(solution.answerFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –æ—Ç–≤–µ—Ç–∞
                                </a>
                            </div>
                        </div>
                        <div class="mb-3" th:if="${solution.grade != null}">
                            <label class="form-label">–û—Ü–µ–Ω–∫–∞</label>
                            <div>
                                <span class="badge bg-success fs-6" th:text="${solution.grade.gradeValue}">5</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div class="card mb-4" id="submissionCard" th:if="${solution == null}">
                    <div class="card-header">
                        <h3>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ—à–µ–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                            <form id="solutionForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="answerText" class="form-label">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</label>
                                    <textarea class="form-control" id="answerText" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="answerFile" class="form-label">–§–∞–π–ª —Å —Ä–µ—à–µ–Ω–∏–µ–º</label>
                                    <input class="form-control" type="file" id="answerFile">
                                    <div class="form-text">–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª —Å —Ä–µ—à–µ–Ω–∏–µ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="submitSolution()">
                                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
                                </button>
                            </form>
                    </div>
                </div>
            </div>

            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>–ö—É—Ä—Å:</strong>
                                <span class="text-muted" th:text="${course.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–£—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${lesson.title}">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ó–∞–¥–∞–Ω–∏–µ:</strong>
                                <span class="text-muted" th:text="${task.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${#temporals.format(task.deadline, 'dd.MM.yyyy')}">–¥–¥.–º–º.–≥–≥–≥–≥</span>
                            </li>
                            <li class="mb-2" th:if="${task.taskStatus != null}">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                <span class="text-muted" th:text="${task.taskStatus.statusName}">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="card" th:if="${solution != null}">
                    <div class="card-header">
                        <h5>–°—Ç–∞—Ç—É—Å —Ä–µ—à–µ–Ω–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div th:if="${solution.solutionStatus.statusName == '–°–¥–∞–Ω–æ'}">
                                <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                                <h5 class="text-success">–°–¥–∞–Ω–æ</h5>
                                <p class="text-muted">–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ —Å–¥–∞–Ω–æ –≤–æ–≤—Ä–µ–º—è</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == '–°–¥–∞–Ω–æ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º'}">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-2"></i>
                                <h5 class="text-warning">–°–¥–∞–Ω–æ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º</h5>
                                <p class="text-muted">–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ —Å–¥–∞–Ω–æ –ø–æ—Å–ª–µ –¥–µ–¥–ª–∞–π–Ω–∞</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}">
                                <i class="fas fa-times-circle fa-3x text-danger mb-2"></i>
                                <h5 class="text-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</h5>
                                <p class="text-muted">–î–µ–¥–ª–∞–π–Ω –ø—Ä–æ—à–µ–ª, —Ä–µ—à–µ–Ω–∏–µ –Ω–µ —Å–¥–∞–Ω–æ</p>
                            </div>
                            <div th:if="${solution.solutionStatus.statusName == '–ù–∞–∑–Ω–∞—á–µ–Ω–æ'}">
                                <i class="fas fa-clock fa-3x text-secondary mb-2"></i>
                                <h5 class="text-secondary">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</h5>
                                <p class="text-muted">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ, —Ä–µ—à–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                            </div>
                            <div th:if="${solution.grade != null}" class="mt-3">
                                <span class="badge bg-success fs-6">–û—Ü–µ–Ω–∫–∞: <span th:text="${solution.grade.gradeValue}">5</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-comments"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-4">
                            <form id="commentForm" onsubmit="submitComment(event)">
                                <div class="mb-3">
                                    <label for="commentText" class="form-label">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                    <textarea class="form-control" id="commentText" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </form>
                        </div>

                        
                        <div id="commentsContainer">
                            <div th:if="${#lists.isEmpty(comments)}" class="text-muted text-center py-4">
                                <i class="fas fa-comment-slash fa-2x mb-2"></i>
                                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                            </div>
                            <div th:if="${not #lists.isEmpty(comments)}" id="commentsList">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script th:inline="javascript">
        function submitSolution() {
            const answerText = document.getElementById('answerText').value;
            const answerFileInput = document.getElementById('answerFile');
            const answerFile = answerFileInput.files[0];

            const taskId = [[${task.taskId}]];

            if (answerFile) {
                const fileFormData = new FormData();
                fileFormData.append('file', answerFile);
                
                fetch('/v1/api/files/upload-solution', {
                    method: 'POST',
                    credentials: 'include', // Include session cookies
                    body: fileFormData

                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to upload file');
                    }
                })
                .then(fileData => {

                    const solution = {
                        answerText: answerText,
                        answerFile: fileData.filePath, // Use filePath from MinIO
                        task: { taskId: taskId }
                    };

                    return submitSolutionData(solution);
                })
                .catch(error => {
                    console.error('File upload error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
                });
            } else {

                const solution = {
                    answerText: answerText,
                    task: { taskId: taskId }
                };

                submitSolutionData(solution);
            }
        }
        
        function submitSolutionData(solution) {

            fetch('/v1/api/solutions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Include session cookies
                body: JSON.stringify(solution)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {

                    return response.text().then(text => {
                        throw new Error(text || 'Failed to submit solution');
                    });
                }
            })
            .then(data => {

                const statusName = data.solutionStatus?.statusName || '–°–¥–∞–Ω–æ';
                let statusText = '–°–¥–∞–Ω–æ';
                let alertClass = 'alert-success';
                
                if (statusName === '–°–¥–∞–Ω–æ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º') {
                    statusText = '–°–¥–∞–Ω–æ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º';
                    alertClass = 'alert-warning';
                } else if (statusName === '–°–¥–∞–Ω–æ') {
                    statusText = '–°–¥–∞–Ω–æ';
                    alertClass = 'alert-success';
                } else if (statusName === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') {
                    statusText = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
                    alertClass = 'alert-danger';
                } else if (statusName === '–ù–∞–∑–Ω–∞—á–µ–Ω–æ') {
                    statusText = '–ù–∞–∑–Ω–∞—á–µ–Ω–æ';
                    alertClass = 'alert-secondary';
                }
                
                alert('–†–µ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°—Ç–∞—Ç—É—Å: ' + statusText);

                renderSubmittedSolution(data);
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ—à–µ–Ω–∏—è';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            });
        }
        
        function renderSubmittedSolution(data) {

            const submissionCard = document.getElementById('submissionCard');
            if (submissionCard) {
                submissionCard.remove();
            }

            let submittedCard = document.getElementById('submittedSolutionCard');
            if (!submittedCard) {
                submittedCard = document.createElement('div');
                submittedCard.className = 'card mb-4';
                submittedCard.id = 'submittedSolutionCard';
                submittedCard.innerHTML = `
                    <div class="card-header"><h3>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ</h3></div>
                    <div class="card-body" id="submittedSolutionCardBody"></div>
                `;

                const mainCol = document.querySelector('.col-md-8');
                mainCol.appendChild(submittedCard);
            }
            const body = document.getElementById('submittedSolutionCardBody');
            body.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <input type="text" class="form-control" value="${(data.solutionStatus && data.solutionStatus.statusName) ? data.solutionStatus.statusName : ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</label>
                    <textarea class="form-control" rows="6" readonly>${(data.answerText || '').replace(/</g, '&lt;')}</textarea>
                </div>
                ${data.answerFile ? `
                <div class="mb-3">
                    <label class="form-label">–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞</label>
                    <div>
                        <a class="btn btn-outline-primary" href="/v1/api/files/download?path=${encodeURIComponent(data.answerFile)}" target="_blank">
                            <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –æ—Ç–≤–µ—Ç–∞
                        </a>
                    </div>
                </div>` : ``}
                ${data.grade ? `
                <div class="mb-3">
                    <label class="form-label">–û—Ü–µ–Ω–∫–∞</label>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success fs-6">${data.grade.gradeValue}</span>
                    </div>
                </div>` : ``}
            `;
        }

        const taskId = /*[[${task?.taskId}]]*/ null;
        if (!taskId) {

            const urlMatch = window.location.pathname.match(/\/task\/(\d+)/);
            if (urlMatch) {
                window.taskId = parseInt(urlMatch[1]);
            }
        }
        let commentsData = /*[[${comments}]]*/ [];
        const currentUserEmail = /*[[${#authentication.name}]]*/ '';

        document.addEventListener('DOMContentLoaded', function() {

            loadComments();
        });

        function renderComments() {
            const container = document.getElementById('commentsList');
            if (!container) return;

            if (commentsData.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }

            const topLevelComments = commentsData.filter(c => !c.parentComment || !c.parentComment.commentId);
            const repliesMap = new Map();
            commentsData.forEach(comment => {
                if (comment.parentComment && comment.parentComment.commentId) {
                    const parentId = comment.parentComment.commentId;
                    if (!repliesMap.has(parentId)) {
                        repliesMap.set(parentId, []);
                    }
                    repliesMap.get(parentId).push(comment);
                }
            });

            let html = '';
            topLevelComments.forEach(comment => {
                html += renderComment(comment, repliesMap, 0);
            });
            container.innerHTML = html;
        }

        function renderComment(comment, repliesMap, depth) {
            const indent = depth * 30;
            const replies = repliesMap.get(comment.commentId) || [];
            const userName = comment.user ? (comment.user.firstName + ' ' + comment.user.lastName) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            const createdAt = comment.createdAt ? new Date(comment.createdAt).toLocaleString('ru-RU') : '';
            const currentUserEmail = /*[[${#authentication.name}]]*/ '';
            const isAuthor = comment.user && comment.user.email === currentUserEmail;

            let html = `
                <div class="comment-item mb-3" style="margin-left: ${indent}px;" data-comment-id="${comment.commentId}">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong class="text-primary">${escapeHtml(userName)}</strong>
                                    <small class="text-muted ms-2">${createdAt}</small>
                                </div>
                                ${isAuthor ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.commentId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                            <p class="mb-2">${escapeHtml(comment.text)}</p>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showReplyForm(${comment.commentId})">
                                <i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
                            </button>
                            <div id="replyForm-${comment.commentId}" style="display: none;" class="mt-3">
                                <textarea class="form-control mb-2" id="replyText-${comment.commentId}" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="submitReply(${comment.commentId})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                    <button class="btn btn-sm btn-secondary" onclick="hideReplyForm(${comment.commentId})">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                `;

            replies.forEach(reply => {
                html += renderComment(reply, repliesMap, depth + 1);
            });

            return html;
        }

        function submitComment(event) {
            event.preventDefault();
            const text = document.getElementById('commentText').value.trim();
            if (!text) return;

            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞–Ω–∏—è');
                return;
            }

            const submitButton = event.target.querySelector('button[type="submit"]') || 
                                document.querySelector('button[onclick*="submitComment"]');
            const originalText = submitButton ? submitButton.innerHTML : '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            }

            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ text: text })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .then(comment => {
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('commentText').value = '';
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                setTimeout(() => {
                    loadComments();
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    const commentsList = document.getElementById('commentsList');
                    if (commentsList) {
                        commentsList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
            })
            .finally(() => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText || '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                }
            });
        }

        function submitReply(parentCommentId) {
            const text = document.getElementById(`replyText-${parentCommentId}`).value.trim();
            if (!text) return;

            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞–Ω–∏—è');
                return;
            }

            const replyButton = document.querySelector(`button[onclick="submitReply(${parentCommentId})"]`);
            const originalText = replyButton ? replyButton.innerHTML : '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (replyButton) {
                replyButton.disabled = true;
                replyButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            }

            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    text: text,
                    parentCommentId: parentCommentId
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞');
                }
            })
            .then(comment => {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                setTimeout(() => {
                loadComments();
                hideReplyForm(parentCommentId);
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é
                    const parentComment = document.querySelector(`[data-comment-id="${parentCommentId}"]`);
                    if (parentComment) {
                        parentComment.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + error.message);
            })
            .finally(() => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (replyButton) {
                    replyButton.disabled = false;
                    replyButton.innerHTML = originalText || '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                }
            });
        }

        function showReplyForm(commentId) {
            document.getElementById(`replyForm-${commentId}`).style.display = 'block';
            document.getElementById(`replyText-${commentId}`).focus();
        }

        function hideReplyForm(commentId) {
            document.getElementById(`replyForm-${commentId}`).style.display = 'none';
            document.getElementById(`replyText-${commentId}`).value = '';
        }

        function deleteComment(commentId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

            fetch(`/v1/api/comments/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    loadComments();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            });
        }

        function loadComments() {
            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                console.error('Task ID is not available');
                return;
            }
            
            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 403) {
                        console.error('Access denied to comments');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(comments => {
                if (!comments) comments = [];
                commentsData = comments;
                renderComments();
            })
            .catch(error => {
                console.error('Error loading comments:', error);

                renderComments();
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>