<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель ученика - Онлайн Школа</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .student-card {
            transition: transform 0.2s;
        }
        .student-card:hover {
            transform: translateY(-5px);
        }
        .tab-content {
            min-height: 400px;
        }
        .course-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand" href="/">Онлайн Школа - Панель ученика</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" th:if="${#authentication != null}">
                    Добро пожаловать, <span th:text="${#authentication.name}"></span>!
                </span>
                <a class="nav-link" href="/logout">Выйти</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="studentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="catalog-tab" data-bs-toggle="tab" data-bs-target="#catalog" type="button" role="tab" aria-controls="catalog" aria-selected="true">Каталог курсов</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-courses-tab" data-bs-toggle="tab" data-bs-target="#my-courses" type="button" role="tab" aria-controls="my-courses" aria-selected="false">Мои курсы</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Профиль</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="studentTabsContent">
            <!-- Catalog Tab -->
            <div class="tab-pane fade show active" id="catalog" role="tabpanel" aria-labelledby="catalog-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Каталог курсов</h3>
                        <p class="text-muted">Здесь представлены все доступные курсы. Вы можете записаться на любой курс, который вас интересует.</p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Доступные курсы</h5>
                                <div>
                                    <select id="categoryFilter" class="form-select form-select-sm d-inline-block w-auto me-2" onchange="filterCoursesByCategory()">
                                        <option value="">Все категории</option>
                                    </select>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadAllCourses()">
                                        <i class="fas fa-sync-alt"></i> Обновить
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="coursesList">
                                    <p class="text-muted text-center">Загрузка списка курсов...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Courses Tab -->
            <div class="tab-pane fade" id="my-courses" role="tabpanel" aria-labelledby="my-courses-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Мои курсы</h3>
                        <p class="text-muted">Здесь представлены курсы, на которые вы записались.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Записанные курсы</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadMyCourses()">
                                    <i class="fas fa-sync-alt"></i> Обновить
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="myCoursesList">
                                    <p class="text-muted text-center">Загрузка списка ваших курсов...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>Профиль студента</h3>
                        <p class="text-muted">Здесь вы можете просмотреть информацию о своем профиле.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5>Информация о профиле</h5>
                            </div>
                            <div class="card-body">
                                <div id="profileInfo">
                                    <p class="text-muted text-center">Загрузка информации о профиле...</p>
                                </div>
                                <div class="mt-3 text-center">
                                    <a href="/profile/edit" class="btn btn-primary">Редактировать профиль</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load data for the active tab (catalog by default)
            loadAllCourses();
            loadCategories();
        });

        function loadCategories() {
            fetch('/v1/api/categories', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(categories => {
                const categoryFilter = document.getElementById('categoryFilter');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.textContent = category.categoryName;
                    categoryFilter.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
        }

        function filterCoursesByCategory() {
            const categoryId = document.getElementById('categoryFilter').value;
            if (categoryId) {
                loadCoursesByCategory(categoryId);
            } else {
                loadAllCourses();
            }
        }

        function loadCoursesByCategory(categoryId) {
            fetch(`/v1/api/courses/category/${categoryId}`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(courses => {
                const coursesList = document.getElementById('coursesList');
                if (courses.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">Пока нет доступных курсов в этой категории</p>';
                } else {
                    let html = '<div class="row">';
                    courses.forEach(course => {
                        // Add category display
                        const categoryBadge = course.category ? 
                            `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                        
                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card course-card h-100">
                                    <div class="card-body d-flex flex-column">
                                        ${course.imageUrl ? 
                                            `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                            `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>`}
                                        <h5 class="card-title">
                                            ${categoryBadge}
                                            ${course.title}
                                        </h5>
                                        <p class="card-text flex-grow-1">${course.description || 'Без описания'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Преподаватель: ${course.teacher ? course.teacher.firstName + ' ' + course.teacher.lastName : 'Не указан'}</small>
                                                <span class="badge bg-success">${course.price ? course.price + ' руб.' : 'Бесплатно'}</span>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="/student/course/${course.courseId}" class="btn btn-outline-primary">
                                                    <i class="fas fa-info-circle"></i> Подробнее
                                                </a>
                                                <a href="javascript:void(0)" class="btn btn-primary" onclick="enrollInCourse(${course.courseId})">
                                                    <i class="fas fa-user-plus"></i> Записаться
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('coursesList').innerHTML = '<p class="text-danger text-center">Ошибка загрузки списка курсов</p>';
            });
        }

        function loadAllCourses() {
            fetch('/v1/api/courses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(courses => {
                const coursesList = document.getElementById('coursesList');
                if (courses.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">Пока нет доступных курсов</p>';
                } else {
                    let html = '<div class="row">';
                    courses.forEach(course => {
                        // Add category display
                        const categoryBadge = course.category ? 
                            `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                        
                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card course-card h-100">
                                    <div class="card-body d-flex flex-column">
                                        ${course.imageUrl ? 
                                            `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                            `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>`}
                                        <h5 class="card-title">
                                            ${categoryBadge}
                                            ${course.title}
                                        </h5>
                                        <p class="card-text flex-grow-1">${course.description || 'Без описания'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Преподаватель: ${course.teacher ? course.teacher.firstName + ' ' + course.teacher.lastName : 'Не указан'}</small>
                                                <span class="badge bg-success">${course.price ? course.price + ' руб.' : 'Бесплатно'}</span>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="/student/course/${course.courseId}" class="btn btn-outline-primary">
                                                    <i class="fas fa-info-circle"></i> Подробнее
                                                </a>
                                                <a href="javascript:void(0)" class="btn btn-primary" onclick="enrollInCourse(${course.courseId})">
                                                    <i class="fas fa-user-plus"></i> Записаться
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('coursesList').innerHTML = '<p class="text-danger text-center">Ошибка загрузки списка курсов</p>';
            });
        }

        function loadMyCourses() {
            // Load all my enrollments to check statuses
            fetch('/v1/api/courses/my/enrollments', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(enrollments => {
                const coursesList = document.getElementById('myCoursesList');
                if (enrollments.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">Вы пока не записались ни на один курс</p>';
                } else {
                    let html = '<div class="row">';
                    enrollments.forEach(enrollment => {
                        const course = enrollment.course;
                        if (!course) return; // Skip if no course data

                        // Add category display
                        const categoryBadge = course.category ? 
                            `<span class="badge bg-info me-2">${course.category.categoryName}</span>` : '';
                        
                        // Check if the enrollment status is active
                        const isEnrollmentActive = enrollment.enrollmentStatus && 
                            (enrollment.enrollmentStatus.statusName === "Активен" || 
                             enrollment.enrollmentStatus.statusName === "Активный" || 
                             enrollment.enrollmentStatus.statusName === "Активна" || 
                             enrollment.enrollmentStatus.statusName === "Active");
                        
                        const buttonClass = isEnrollmentActive ? 'btn-primary' : 'btn-secondary disabled';
                        const buttonText = isEnrollmentActive ? '<i class="fas fa-book-open"></i> Перейти к курсу' :
                                                 '<i class="fas fa-clock"></i> Ожидает подтверждения';
                        const buttonAction = isEnrollmentActive ? `href="/student/course/${course.courseId}"` : 'href="javascript:void(0)"';
                        const buttonOnclick = isEnrollmentActive ? '' : 'onclick="showPendingMessage(); return false;"';
                        
                        // Display enrollment status
                        const statusText = enrollment.enrollmentStatus ? enrollment.enrollmentStatus.statusName : 'Неизвестно';
                        const statusClass = isEnrollmentActive ? 'text-success' : 'text-warning';

                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card course-card h-100">
                                    <div class="card-body d-flex flex-column">
                                        ${course.imageUrl ? 
                                            `<img src="${course.imageUrl}" class="card-img-top mb-2" style="width: 100%; height: 150px; object-fit: cover;" alt="${course.title}">` : 
                                            `<div class="bg-light mb-2" style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>`}
                                        <h5 class="card-title">
                                            ${categoryBadge}
                                            ${course.title}
                                        </h5>
                                        <p class="card-text flex-grow-1">${course.description || 'Без описания'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Преподаватель: ${course.teacher ? course.teacher.firstName + ' ' + course.teacher.lastName : 'Не указан'}</small>
                                                <span class="badge bg-success">${course.price ? course.price + ' руб.' : 'Бесплатно'}</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="${statusClass}"><strong>Статус записи: ${statusText}</strong></small>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a ${buttonAction} class="btn ${buttonClass}" ${buttonOnclick}>
                                                    ${buttonText}
                                                </a>
                                                <a href="/student/course/${course.courseId}" class="btn btn-outline-primary">
                                                    <i class="fas fa-info-circle"></i> Подробнее
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('myCoursesList').innerHTML = '<p class="text-danger text-center">Ошибка загрузки списка ваших курсов</p>';
            });
        }

        function loadProfile() {
            fetch('/v1/api/auth/me', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(user => {
                const profileInfo = document.getElementById('profileInfo');
                profileInfo.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                ${user.imageUrl ? 
                                    `<img src="${user.imageUrl}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;" alt="Profile image">` : 
                                    `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                                        <i class="fas fa-user fa-3x text-secondary"></i>
                                    </div>`}
                                <h5 class="mt-2">${user.firstName} ${user.lastName}</h5>
                                <p class="text-muted">${user.role ? user.role.roleName : 'Студент'}</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Личная информация</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Имя:</strong></td>
                                    <td>${user.firstName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Фамилия:</strong></td>
                                    <td>${user.lastName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Отчество:</strong></td>
                                    <td>${user.middleName || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>${user.email || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Дата регистрации:</strong></td>
                                    <td>${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('ru-RU') : 'Не указана'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById('profileInfo').innerHTML = '<p class="text-danger text-center">Ошибка загрузки информации о профиле</p>';
            });
        }

        // Load profile when profile tab is shown
        document.getElementById('profile-tab').addEventListener('shown.bs.tab', function (e) {
            loadProfile();
        });

        // Load my courses when my courses tab is shown
        document.getElementById('my-courses-tab').addEventListener('shown.bs.tab', function (e) {
            loadMyCourses();
        });

        function enrollInCourse(courseId) {
            if (confirm('Вы уверены, что хотите записаться на этот курс?')) {
                fetch(`/v1/api/courses/${courseId}/enroll`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Вы успешно записались на курс!');
                        // Refresh the courses list
                        loadAllCourses();
                    } else {
                        alert('Ошибка при записи на курс');
                    }
                })
                .catch(error => {
                    alert('Ошибка при записи на курс: ' + error.message);
                });
            }
        }

        function showPendingMessage() {
            alert('Ваша запись на курс находится на рассмотрении. После подтверждения оплаты администратором, курс станет доступен.');
        }

        function viewCourse(courseId) {
            // Redirect to course details page
            window.location.href = '/student/course/' + courseId;
        }
    </script>
</body>
</html>