<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${task.title + ' - ' + lesson.title + ' - SupSchool'}">–ó–∞–¥–∞–Ω–∏–µ - SupSchool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom-theme.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user-settings.js"></script>
    <script src="/js/teacher-hotkeys.js"></script>
    <style>
        .task-header {
            position: relative;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .task-title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0;
            text-align: center;
        }
        
        .solution-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        
        .solution-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .comment-item {
            transition: transform 0.2s;
        }
        
        .comment-item:hover {
            transform: translateX(5px);
        }
        
        .comment-item .card {
            border-left: 3px solid #0d6efd;
        }
        
        .comment-item[style*="margin-left: 30px"] .card {
            border-left-color: #6c757d;
        }
        
        .comment-item[style*="margin-left: 60px"] .card {
            border-left-color: #adb5bd;
        }
    </style>
</head>
<body data-context="teacher-task"
      th:data-course-id="${course.courseId}"
      th:data-lesson-id="${lesson.lessonId}"
      th:data-task-id="${task.taskId}">
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container">
            <a class="navbar-brand text-white" href="/">SupSchool</a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3 text-white" th:if="${#authentication != null}">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span th:text="${#authentication.name}"></span>!
                </span>
                <button id="themeToggle" class="btn btn-sm btn-outline-light me-2" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    üåô
                </button>
                <a class="nav-link text-white" th:href="@{/teacher/course/{courseId}/lesson/{lessonId}(courseId=${course.courseId}, lessonId=${lesson.lessonId})}">–ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫—É</a>
                <a class="nav-link text-white" th:href="@{/teacher/course/{courseId}(courseId=${course.courseId})}">–ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É</a>
                <a class="nav-link text-white" href="/teacher">–ú–æ–∏ –∫—É—Ä—Å—ã</a>
                <a class="nav-link text-white" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    
    <div class="task-header">
        <h1 class="task-title" th:text="${task.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>
    </div>

    <div class="container">
        <div class="row">
            
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.description}" th:utext="${task.description}">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
                        <div th:if="${task.description == null}" class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
                    </div>
                </div>
                
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∑–∞–¥–∞–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${task.attachedFile != null && !task.attachedFile.isEmpty()}">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-pdf fa-2x me-3 text-danger"></i>
                            <div>
                                <h5>–§–∞–π–ª –∑–∞–¥–∞–Ω–∏—è</h5>
                                    <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(task.attachedFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∑–∞–¥–∞–Ω–∏—è
                                </a>
                                </div>
                            </div>
                        </div>
                        <div th:if="${task.attachedFile == null || task.attachedFile.isEmpty()}" class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫ –∑–∞–¥–∞–Ω–∏—é –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>–ö—É—Ä—Å:</strong>
                                <span class="text-muted" th:text="${course.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–£—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${lesson.title}">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ó–∞–¥–∞–Ω–∏–µ:</strong>
                                <span class="text-muted" th:text="${task.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫:</strong>
                                <span class="text-muted" th:text="${#temporals.format(task.deadline, 'dd.MM.yyyy')}">–¥–¥.–º–º.–≥–≥–≥–≥</span>
                            </li>
                            <li class="mb-2" th:if="${task.taskStatus != null}">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                <span class="text-muted" th:text="${task.taskStatus.statusName}">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>–î–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning w-100 mb-2" onclick="editTask()" data-action="edit-task">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                        <button class="btn btn-danger w-100" onclick="deleteTask()">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>–†–µ—à–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
                        <span class="badge bg-primary" th:text="${#lists.size(solutions)}">0</span>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(solutions)}">
                            <p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—à–µ–Ω–∏–π –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                        </div>
                        
                        <div th:if="${not #lists.isEmpty(solutions)}" class="row">
                            <div class="col-md-6 col-lg-4 mb-4" th:each="solution : ${solutions}">
                                <div class="card solution-card h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title" th:text="${solution.user.firstName + ' ' + solution.user.lastName}">–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞</h5>
                                        <p class="card-text flex-grow-1">
                                            <small class="text-muted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <span th:text="${#temporals.format(solution.submitDate, 'dd.MM.yyyy')}">–¥–¥.–º–º.–≥–≥–≥–≥</span></small>
                                        </p>
                                        
                                        <div th:if="${solution.solutionStatus != null}">
                                            <span th:if="${solution.solutionStatus.statusName == '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'}" class="badge bg-warning">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                            <span th:if="${solution.solutionStatus.statusName == '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'}" class="badge bg-info">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                            <span th:if="${solution.solutionStatus.statusName == '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ'}" class="badge bg-success">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                        </div>
                                        
                                        
                                        <div th:if="${solution.grade != null}" class="mt-2">
                                            <span class="badge bg-success">–û—Ü–µ–Ω–∫–∞: <span th:text="${solution.grade.gradeValue}">5</span></span>
                                        </div>
                                        
                                        <div class="mt-2">
                                            <div th:if="${solution.answerText}">
                                                <h6>–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:</h6>
                                                <p th:text="${#strings.abbreviate(solution.answerText, 100)}">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</p>
                                            </div>
                                            
                                            <div th:if="${solution.answerFile}">
                                                <h6>–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞:</h6>
                                                <a th:href="@{'/v1/api/files/download?path=' + ${#strings.replace(#strings.replace(solution.answerFile, '/', '%2F'), ' ', '%20')}}" class="btn btn-outline-primary btn-sm" target="_blank">
                                                    <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                                </a>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-auto pt-2">
                                            <a th:href="@{/teacher/solution/{solutionId}(solutionId=${solution.solutionId})}" class="btn btn-primary w-100">
                                                <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-comments"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-4">
                            <form id="commentForm" onsubmit="submitComment(event)">
                                <div class="mb-3">
                                    <label for="commentText" class="form-label">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                    <textarea class="form-control" id="commentText" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </form>
                        </div>

                        
                        <div id="commentsContainer">
                            <div th:if="${#lists.isEmpty(comments)}" class="text-muted text-center py-4">
                                <i class="fas fa-comment-slash fa-2x mb-2"></i>
                                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                            </div>
                            <div th:if="${not #lists.isEmpty(comments)}" id="commentsList">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        function editTask() {
            const courseId = /*[[${course.courseId}]]*/ '1';
            const lessonId = /*[[${lesson.lessonId}]]*/ '1';
            const taskId = /*[[${task.taskId}]]*/ '1';
            window.location.href = `/teacher/course/${courseId}/lesson/${lessonId}/task/${taskId}/edit`;
        }
        
        function deleteTask() {
            const courseId = /*[[${course.courseId}]]*/ '1';
            const lessonId = /*[[${lesson.lessonId}]]*/ '1';
            const taskId = /*[[${task.taskId}]]*/ '1';
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/teacher/course/${courseId}/lesson/${lessonId}/task/${taskId}/delete`;

                const csrfToken = document.querySelector('meta[name="_csrf"]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken.content;
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        const taskId = /*[[${task?.taskId}]]*/ null;
        console.log('Task ID from server:', taskId);
        if (!taskId) {
            console.error('Task ID is null! Task object:', /*[[${task}]]*/ null);

            const urlMatch = window.location.pathname.match(/\/task\/(\d+)/);
            if (urlMatch) {
                const urlTaskId = parseInt(urlMatch[1]);
                console.log('Found taskId from URL:', urlTaskId);

                window.taskId = urlTaskId;
            }
        }

        const finalTaskId = taskId || window.taskId;
        if (!finalTaskId) {
            console.error('Could not determine taskId!');
        }
        let commentsData = /*[[${comments}]]*/ [];
        const currentUserEmail = /*[[${#authentication.name}]]*/ '';

        document.addEventListener('DOMContentLoaded', function() {

            loadComments();
        });

        function renderComments() {
            const container = document.getElementById('commentsList');
            if (!container) return;

            if (commentsData.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }

            const topLevelComments = commentsData.filter(c => !c.parentComment || !c.parentComment.commentId);
            const repliesMap = new Map();
            commentsData.forEach(comment => {
                if (comment.parentComment && comment.parentComment.commentId) {
                    const parentId = comment.parentComment.commentId;
                    if (!repliesMap.has(parentId)) {
                        repliesMap.set(parentId, []);
                    }
                    repliesMap.get(parentId).push(comment);
                }
            });

            let html = '';
            topLevelComments.forEach(comment => {
                html += renderComment(comment, repliesMap, 0);
            });
            container.innerHTML = html;
        }

        function renderComment(comment, repliesMap, depth) {
            const indent = depth * 30;
            const replies = repliesMap.get(comment.commentId) || [];
            const userName = comment.user ? (comment.user.firstName + ' ' + comment.user.lastName) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            const createdAt = comment.createdAt ? new Date(comment.createdAt).toLocaleString('ru-RU') : '';
            const isAuthor = comment.user && comment.user.email === currentUserEmail;
            const isTeacher = /*[[${course.teacher.email}]]*/ '' === currentUserEmail;

            let html = `
                <div class="comment-item mb-3" style="margin-left: ${indent}px;" data-comment-id="${comment.commentId}">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong class="text-primary">${escapeHtml(userName)}</strong>
                                    <small class="text-muted ms-2">${createdAt}</small>
                                </div>
                                ${(isAuthor || isTeacher) ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.commentId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                            <p class="mb-2">${escapeHtml(comment.text)}</p>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showReplyForm(${comment.commentId})">
                                <i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
                            </button>
                            <div id="replyForm-${comment.commentId}" style="display: none;" class="mt-3">
                                <textarea class="form-control mb-2" id="replyText-${comment.commentId}" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="submitReply(${comment.commentId})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                    <button class="btn btn-sm btn-secondary" onclick="hideReplyForm(${comment.commentId})">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            replies.forEach(reply => {
                html += renderComment(reply, repliesMap, depth + 1);
            });

            return html;
        }

        function submitComment(event) {
            event.preventDefault();
            const text = document.getElementById('commentText').value.trim();
            if (!text) return;

            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞–Ω–∏—è');
                console.error('TaskId is null when submitting comment');
                return;
            }

            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ text: text })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .then(comment => {

                loadComments();
                document.getElementById('commentText').value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
            });
        }

        function submitReply(parentCommentId) {
            const text = document.getElementById(`replyText-${parentCommentId}`).value.trim();
            if (!text) return;

            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞–Ω–∏—è');
                console.error('TaskId is null when submitting reply');
                return;
            }

            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    text: text,
                    parentCommentId: parentCommentId
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞');
                }
            })
            .then(comment => {

                loadComments();
                hideReplyForm(parentCommentId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + error.message);
            });
        }

        function showReplyForm(commentId) {
            document.getElementById(`replyForm-${commentId}`).style.display = 'block';
            document.getElementById(`replyText-${commentId}`).focus();
        }

        function hideReplyForm(commentId) {
            document.getElementById(`replyForm-${commentId}`).style.display = 'none';
            document.getElementById(`replyText-${commentId}`).value = '';
        }

        function deleteComment(commentId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

            fetch(`/v1/api/comments/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    loadComments();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            });
        }

        function loadComments() {
            const currentTaskId = taskId || window.taskId;
            if (!currentTaskId) {
                console.error('Task ID is not available');
                return;
            }
            
            console.log('Loading comments for task:', currentTaskId);
            
            fetch(`/v1/api/comments/task/${currentTaskId}`, {
                credentials: 'include'
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    if (response.status === 403) {
                        console.error('Access denied to comments - 403 Forbidden');
                        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞.');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(comments => {
                if (!comments) comments = [];
                console.log('Loaded comments:', comments.length, comments);
                commentsData = comments;
                renderComments();
            })
            .catch(error => {
                console.error('Error loading comments:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ' + error.message);

                renderComments();
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>