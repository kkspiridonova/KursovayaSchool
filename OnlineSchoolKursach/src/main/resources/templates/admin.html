<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - SupSchool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/custom-theme.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/user-settings.js"></script>
    <style>
        .admin-card {
            transition: transform 0.2s;
        }
        .admin-card:hover {
            transform: translateY(-5px);
        }
        .tab-content {
            min-height: 400px;
        }
        .table-card {
            transition: transform 0.2s;
            border: 1px solid #dee2e6;
        }
        .table-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container">
            <a class="navbar-brand text-white" href="/">SupSchool - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3 text-white" th:if="${#authentication != null}">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span th:text="${#authentication.name}"></span>!
                </span>
                <button id="themeToggle" class="btn btn-sm btn-outline-light me-2" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                    üåô
                </button>
                <a class="nav-link text-white" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab" aria-controls="courses" aria-selected="true">–ö—É—Ä—Å—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="false">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="enrollments-tab" data-bs-toggle="tab" data-bs-target="#enrollments" type="button" role="tab" aria-controls="enrollments" aria-selected="false">–ó–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="lessons-tab" data-bs-toggle="tab" data-bs-target="#lessons" type="button" role="tab" aria-controls="lessons" aria-selected="false">–£—Ä–æ–∫–∏</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab" aria-controls="tasks" aria-selected="false">–ó–∞–¥–∞–Ω–∏—è</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="certificates-tab" data-bs-toggle="tab" data-bs-target="#certificates" type="button" role="tab" aria-controls="certificates" aria-selected="false">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="checks-tab" data-bs-toggle="tab" data-bs-target="#checks" type="button" role="tab" aria-controls="checks" aria-selected="false">–ß–µ–∫–∏</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gift-cards-tab" data-bs-toggle="tab" data-bs-target="#gift-cards" type="button" role="tab" aria-controls="gift-cards" aria-selected="false">–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∫–∞—Ä—Ç—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab" aria-controls="comments" aria-selected="false">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">
                    <i class="fas fa-chart-pie"></i> –ì—Ä–∞—Ñ–∏–∫–∏
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab" aria-controls="audit" aria-selected="false">
                    <i class="fas fa-history"></i> –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞
                </button>
            </li>
        </ul>

        
        <div class="tab-content" id="adminTabsContent">
            
            <div class="tab-pane fade show active" id="courses" role="tabpanel" aria-labelledby="courses-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏</h3>
                        <p class="text-muted">–ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ).</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('courses')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤</h5>
                                <button class="btn btn-outline-danger btn-sm" onclick="loadCourses()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="coursesList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('users')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadUsers()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="usersList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫—É—Ä—Å–æ–≤</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∫—É—Ä—Å–æ–≤.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('categories')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadCategories()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="categoriesList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="enrollments" role="tabpanel" aria-labelledby="enrollments-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ó–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –∫—É—Ä—Å—ã.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('enrollments')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadEnrollments()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="enrollmentsList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="lessons" role="tabpanel" aria-labelledby="lessons-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–£—Ä–æ–∫–∏</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞–º–∏ –∫—É—Ä—Å–æ–≤.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('lessons')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('lessons')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="lessonsList"></div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

            
            <div class="tab-pane fade" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ó–∞–¥–∞–Ω–∏—è</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('tasks')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('tasks')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="tasksList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            
            <div class="tab-pane fade" id="certificates" role="tabpanel" aria-labelledby="certificates-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('certificates')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('certificates')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="certificatesList"></div>
                            </div>
                        </div>
            </div>
        </div>
    </div>

            
            <div class="tab-pane fade" id="checks" role="tabpanel" aria-labelledby="checks-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ß–µ–∫–∏</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–∞–º–∏ –ø–ª–∞—Ç–µ–∂–µ–π.</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ —á–µ–∫–æ–≤</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('checks')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="checksList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="gift-cards" role="tabpanel" aria-labelledby="gift-cards-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∫–∞—Ä—Ç—ã</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('gift-cards')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('gift-cards')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="gift-cardsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateModal('comments')">
                            <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadTableData('comments')">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="commentsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã –ø–æ –∫—É—Ä—Å–∞–º</h3>
                        <p class="text-muted">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∫—É—Ä—Å–∞–º —Å–∏—Å—Ç–µ–º—ã.</p>
                    </div>
                </div>

                
                <div class="row mt-3 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-file-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6>–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV:</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-success btn-sm" onclick="exportToCsv('users')">
                                                <i class="fas fa-download"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="exportToCsv('courses')">
                                                <i class="fas fa-download"></i> –ö—É—Ä—Å—ã
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="exportToCsv('enrollments')">
                                                <i class="fas fa-download"></i> –ó–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="exportToCsv('statistics')">
                                                <i class="fas fa-download"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫—É—Ä—Å–∞–º
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6>–ò–º–ø–æ—Ä—Ç –∏–∑ CSV:</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <label class="btn btn-primary btn-sm">
                                                <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                                                <input type="file" accept=".csv" style="display: none;" onchange="importFromCsv('users', this.files[0])">
                                            </label>
                                            <label class="btn btn-primary btn-sm">
                                                <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç –∫—É—Ä—Å–æ–≤
                                                <input type="file" accept=".csv" style="display: none;" onchange="importFromCsv('courses', this.files[0])">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div id="importResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫—É—Ä—Å–∞–º</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadReports()">
                                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="reportsList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <label for="dateFrom" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                                        <input type="date" class="form-control" id="dateFrom" onchange="updateCharts()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dateTo" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                                        <input type="date" class="form-control" id="dateTo" onchange="updateCharts()">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button class="btn btn-primary w-100" onclick="updateCharts()">
                                                <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button class="btn btn-success w-100" onclick="exportChartsToPDF()">
                                                <i class="fas fa-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <h3><i class="fas fa-chart-pie"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                        <p class="text-muted">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∫—É—Ä—Å–æ–≤</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>–¢–æ–ø-5 –∫—É—Ä—Å–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                            </div>
                            <div class="card-body">
                                <div id="dashboardStats">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –∫—É—Ä—Å–∞–º</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="studentsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="audit" role="tabpanel" aria-labelledby="audit-tab">
                <div class="row mt-4">
                    <div class="col-12">
                        <h3><i class="fas fa-history"></i> –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞</h3>
                        <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block" id="auditLimit" style="width: auto;" onchange="loadAuditLogs()">
                                        <option value="50">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50</option>
                                        <option value="100" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100</option>
                                        <option value="200">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 200</option>
                                        <option value="500">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 500</option>
                                    </select>
                                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="loadAuditLogs()">
                                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="auditLogsList">
                                    <p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                    <input type="hidden" id="deleteItemType">
                    <input type="hidden" id="deleteItemId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStatusModalLabel">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editEnrollmentId">
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                        <select class="form-select" id="statusSelect">
                            
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="updateEnrollmentStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>

        let enrollmentStatuses = [];

        document.addEventListener('DOMContentLoaded', function() {

            loadCourses();

            loadEnrollmentStatuses();
        });

        function loadCourses() {
            fetch('/v1/api/courses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(courses => {
                const coursesList = document.getElementById('coursesList');
                if (courses.length === 0) {
                    coursesList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    courses.forEach(course => {
                        html += `
                            <tr>
                                <td>${course.courseId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${course.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
                                <td>${course.teacher ? course.teacher.firstName + ' ' + course.teacher.lastName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${course.price ? course.price + ' —Ä—É–±.' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</td>
                                <td>${course.courseStatus ? course.courseStatus.statusName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${course.category ? course.category.categoryName : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm me-1" onclick="showEditModal('courses', ${course.courseId})">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteItem('courses', ${course.courseId})">
                                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    coursesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('coursesList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤</p>';
            });
        }

        function loadUsers() {
            fetch('/v1/api/admin/users', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('usersList');
                if (users.length === 0) {
                    usersList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ò–º—è</th>
                                        <th>–§–∞–º–∏–ª–∏—è</th>
                                        <th>Email</th>
                                        <th>–†–æ–ª—å</th>
                                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    users.forEach(user => {
                        html += `
                            <tr>
                                <td>${user.userId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${user.firstName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td>${user.lastName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${user.role ? user.role.roleName : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                <td>${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="showEditModal('users', ${user.userId})">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    usersList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('usersList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
            });
        }

        function loadCategories() {
            fetch('/v1/api/categories', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(categories => {
                const categoriesList = document.getElementById('categoriesList');
                if (categories.length === 0) {
                    categoriesList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    categories.forEach(category => {
                        html += `
                            <tr>
                                <td>${category.categoryId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${category.categoryName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
                                <td>${category.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm me-1" onclick="showEditModal('categories', ${category.categoryId})">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteItem('categories', ${category.categoryId})">
                                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    categoriesList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('categoriesList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>';
            });
        }

        function loadEnrollments() {
            fetch('/v1/api/admin/enrollments', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(enrollments => {
                const enrollmentsList = document.getElementById('enrollmentsList');
                if (enrollments.length === 0) {
                    enrollmentsList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∫—É—Ä—Å—ã</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                        <th>–ö—É—Ä—Å</th>
                                        <th>–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    enrollments.forEach(enrollment => {
                        html += `
                            <tr>
                                <td>${enrollment.enrollmentId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${enrollment.user ? enrollment.user.firstName + ' ' + enrollment.user.lastName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${enrollment.course ? enrollment.course.title : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>${enrollment.enrollmentDate ? new Date(enrollment.enrollmentDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                <td>${enrollment.enrollmentStatus ? enrollment.enrollmentStatus.statusName : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="showEditStatusModal(${enrollment.enrollmentId}, ${enrollment.enrollmentStatus ? enrollment.enrollmentStatus.enrollmentStatusId : ''})">
                                        <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    enrollmentsList.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('enrollmentsList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π</p>';
            });
        }

        const tableEndpoints = {
            'users': '/v1/api/admin/users',
            'courses': '/v1/api/admin/courses',
            'categories': '/v1/api/admin/categories',
            'enrollments': '/v1/api/admin/enrollments',
            'lessons': '/v1/api/admin/lessons',
            'tasks': '/v1/api/admin/tasks',
            'solutions': '/v1/api/admin/solutions',
            'grades': '/v1/api/admin/grades',
            'certificates': '/v1/api/admin/certificates',
            'checks': '/v1/api/admin/checks',
            'gift-cards': '/v1/api/admin/gift-cards',
            'comments': '/v1/api/admin/comments'
        };

        function loadTableData(tableName) {
            const endpoint = tableEndpoints[tableName];
            if (!endpoint) {
                console.error('Unknown table:', tableName);
                return;
            }

            const listElement = document.getElementById(tableName + 'List');
            if (!listElement) {
                console.error('List element not found for:', tableName);
                return;
            }

            listElement.innerHTML = '<p class="text-muted text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

            fetch(endpoint, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded data for', tableName, ':', data);
                if (!data || data.length === 0) {
                    listElement.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                } else {
                    listElement.innerHTML = renderTable(data, tableName);
                }
            })
            .catch(error => {
                console.error('Error loading', tableName, ':', error);
                listElement.innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '</p>';
            });
        }

        function renderTable(data, tableName) {
            if (!data || data.length === 0) return '<p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            
            const firstItem = data[0];
            const columns = Object.keys(firstItem).filter(key => {
                const value = firstItem[key];
                if (key.includes('password')) return false;
                if (tableName === 'grades' && key === 'solution') return false;
                return true;
            });

                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                ${columns.map(col => `<th>${formatColumnName(col)}</th>`).join('')}
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
            data.forEach(item => {
                const idField = getIdField(tableName);
                const id = item[idField];
                if (!id) {
                    console.warn('Item without ID:', item);
                    return;
                }
                html += '<tr>';
                columns.forEach(col => {
                    let value = item[col];
                    if (value === null || value === undefined) value = '-';
                    else if (typeof value === 'object' && value !== null) {
                        if (value.taskId) value = '–ó–∞–¥–∞–Ω–∏–µ #' + value.taskId + (value.title ? ' (' + value.title + ')' : '');
                        else if (value.userId) value = (value.firstName && value.lastName ? value.firstName + ' ' + value.lastName : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #' + value.userId) + (value.email ? ' (' + value.email + ')' : '');
                        else if (value.gradeId) value = '–û—Ü–µ–Ω–∫–∞ #' + value.gradeId + (value.gradeValue !== undefined ? ' (' + value.gradeValue + ')' : '');
                        else if (value.lessonId) value = '–£—Ä–æ–∫ #' + value.lessonId + (value.title ? ' (' + value.title + ')' : '');
                        else if (value.courseId) value = '–ö—É—Ä—Å #' + value.courseId + (value.title ? ' (' + value.title + ')' : '');
                        else if (value.solutionId) value = '–†–µ—à–µ–Ω–∏–µ #' + value.solutionId;
                        else if (value.id) value = value.id;
                        else if (value.name) value = value.name;
                        else if (value.statusName) value = value.statusName;
                        else if (value.title) value = value.title;
                        else if (value.firstName && value.lastName) value = value.firstName + ' ' + value.lastName;
                        else if (value.categoryName) value = value.categoryName;
                        else if (value.roleName) value = value.roleName;
                        else value = JSON.stringify(value).substring(0, 50) + '...';
                    } else if (typeof value === 'boolean') value = value ? '–î–∞' : '–ù–µ—Ç';
                    else if (typeof value === 'string' && value.length > 100) value = value.substring(0, 100) + '...';
                    if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        try {
                            const date = new Date(value + 'T00:00:00');
                            value = date.toLocaleDateString('ru-RU');
                        } catch (e) {
                        }
                    }
                    html += `<td>${escapeHtml(String(value))}</td>`;
                });
                        html += `
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="showEditModal('${tableName}', ${id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('${tableName}', ${id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getIdField(tableName) {
            const idFields = {
                'users': 'userId',
                'courses': 'courseId',
                'categories': 'categoryId',
                'enrollments': 'enrollmentId',
                'lessons': 'lessonId',
                'tasks': 'taskId',
                'solutions': 'solutionId',
                'grades': 'gradeId',
                'certificates': 'certificateId',
                'checks': 'checkId',
                'gift-cards': 'giftCardId',
                'comments': 'commentId'
            };
            return idFields[tableName] || 'id';
        }

        function formatColumnName(col) {
            const names = {
                'lessonId': 'ID', 'taskId': 'ID', 'solutionId': 'ID', 'gradeId': 'ID',
                'certificateId': 'ID', 'checkId': 'ID', 'giftCardId': 'ID', 'commentId': 'ID',
                'title': '–ù–∞–∑–≤–∞–Ω–∏–µ', 'description': '–û–ø–∏—Å–∞–Ω–∏–µ', 'content': '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ',
                'submitDate': '–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'gradeValue': '–û—Ü–µ–Ω–∫–∞',
                'issueDate': '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏', 'amount': '–°—É–º–º–∞', 'paymentDate': '–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞',
                'code': '–ö–æ–¥', 'balance': '–ë–∞–ª–∞–Ω—Å', 'text': '–¢–µ–∫—Å—Ç', 'createdAt': '–°–æ–∑–¥–∞–Ω',
                'answerText': '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞', 'answerFile': '–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞', 'task': '–ó–∞–¥–∞–Ω–∏–µ',
                'user': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'grade': '–û—Ü–µ–Ω–∫–∞', 'solutionStatus': '–°—Ç–∞—Ç—É—Å',
                'lessonStatus': '–°—Ç–∞—Ç—É—Å', 'taskStatus': '–°—Ç–∞—Ç—É—Å', 'courseStatus': '–°—Ç–∞—Ç—É—Å',
                'enrollmentStatus': '–°—Ç–∞—Ç—É—Å', 'paymentStatus': '–°—Ç–∞—Ç—É—Å', 'certificateStatus': '–°—Ç–∞—Ç—É—Å',
                'category': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'course': '–ö—É—Ä—Å', 'lesson': '–£—Ä–æ–∫', 'teacher': '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å',
                'role': '–†–æ–ª—å', 'deadline': '–î–µ–¥–ª–∞–π–Ω', 'attachedFile': '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª',
                'certificateNumber': '–ù–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞', 'filePath': '–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É',
                'documentFile': '–î–æ–∫—É–º–µ–Ω—Ç', 'emailSent': 'Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'emailSentDate': '–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email',
                'cardNumber': '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã', 'expiryDate': '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è', 'issueDate': '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏',
                'parentCommentId': '–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', 'lesson': '–£—Ä–æ–∫', 'task': '–ó–∞–¥–∞–Ω–∏–µ'
            };
            return names[col] || col;
        }

        let referenceData = {
            roles: [],
            courseStatuses: [],
            lessonStatuses: [],
            taskStatuses: [],
            solutionStatuses: [],
            enrollmentStatuses: [],
            paymentStatuses: [],
            certificateStatuses: [],
            categories: [],
            courses: [],
            lessons: [],
            tasks: [],
            users: [],
            grades: [],
            giftCardStatuses: []
        };

        function loadReferenceData() {
            Promise.all([
                fetch('/v1/api/admin/roles').then(r => r.json()).then(d => referenceData.roles = d),
                fetch('/v1/api/admin/course-statuses').then(r => r.json()).then(d => referenceData.courseStatuses = d),
                fetch('/v1/api/admin/lesson-statuses').then(r => r.json()).then(d => referenceData.lessonStatuses = d),
                fetch('/v1/api/admin/task-statuses').then(r => r.json()).then(d => referenceData.taskStatuses = d),
                fetch('/v1/api/admin/solution-statuses').then(r => r.json()).then(d => referenceData.solutionStatuses = d),
                fetch('/v1/api/admin/enrollment-statuses').then(r => r.json()).then(d => referenceData.enrollmentStatuses = d),
                fetch('/v1/api/admin/payment-statuses').then(r => r.json()).then(d => referenceData.paymentStatuses = d),
                fetch('/v1/api/admin/certificate-statuses').then(r => r.json()).then(d => referenceData.certificateStatuses = d),
                fetch('/v1/api/admin/gift-card-statuses').then(r => r.json()).then(d => referenceData.giftCardStatuses = d),
                fetch('/v1/api/admin/categories').then(r => r.json()).then(d => referenceData.categories = d),
                fetch('/v1/api/admin/courses').then(r => r.json()).then(d => referenceData.courses = d),
                fetch('/v1/api/admin/lessons').then(r => r.json()).then(d => referenceData.lessons = d),
                fetch('/v1/api/admin/tasks').then(r => r.json()).then(d => referenceData.tasks = d),
                fetch('/v1/api/admin/users').then(r => r.json()).then(d => referenceData.users = d),
                fetch('/v1/api/admin/grades').then(r => r.json()).then(d => referenceData.grades = d)
            ]).catch(err => console.error('Error loading reference data:', err));
        }

        loadReferenceData();

        function showCreateModal(tableName) {
            showCrudModal(tableName, null);
        }

        function showEditModal(tableName, id) {
            const endpoint = tableEndpoints[tableName];
            if (!endpoint) {
                alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: ' + tableName);
                return;
            }

            fetch(endpoint + '/' + id, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                showCrudModal(tableName, data);
            })
            .catch(error => {
                console.error('Error loading item:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            });
        }

        function showCrudModal(tableName, item) {
            const isEdit = item !== null;
            const modalId = 'crudModal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.setAttribute('tabindex', '-1');
            
            const formFields = getFormFields(tableName, item);
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'} ${getTableDisplayName(tableName)}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="crudForm">
                                ${formFields}
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="button" class="btn btn-primary" onclick="saveItem('${tableName}', ${isEdit ? item[getIdField(tableName)] : 'null'})">
                                ${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        function getTableDisplayName(tableName) {
            const names = {
                'users': '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                'courses': '–∫—É—Ä—Å',
                'categories': '–∫–∞—Ç–µ–≥–æ—Ä–∏—é',
                'enrollments': '–∑–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å',
                'lessons': '—É—Ä–æ–∫',
                'tasks': '–∑–∞–¥–∞–Ω–∏–µ',
                'solutions': '—Ä–µ—à–µ–Ω–∏–µ',
                'grades': '–æ—Ü–µ–Ω–∫—É',
                'certificates': '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç',
                'checks': '—á–µ–∫',
                'gift-cards': '–ø–æ–¥–∞—Ä–æ—á–Ω—É—é –∫–∞—Ä—Ç—É',
                'comments': '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'
            };
            return names[tableName] || tableName;
        }

        function getFormFields(tableName, item) {
            const isEdit = item !== null;
            let fields = '';

            switch(tableName) {
                case 'users':
                    if (isEdit) {

                        fields = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                                <input type="text" class="form-control" value="${item?.firstName || ''} ${item?.lastName || ''} (${item?.email || ''})" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–†–æ–ª—å *</label>
                                <select class="form-select" name="role.roleId" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                    ${referenceData.roles.map(r => 
                                        `<option value="${r.roleId}" ${item?.role?.roleId === r.roleId ? 'selected' : ''}>${r.roleName}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                    } else {

                        fields = `
                            <div class="mb-3">
                                <label class="form-label">–ò–º—è *</label>
                                <input type="text" class="form-control" name="firstName" value="${item?.firstName || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                                <input type="text" class="form-control" name="lastName" value="${item?.lastName || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                                <input type="text" class="form-control" name="middleName" value="${item?.middleName || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" value="${item?.email || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                                <input type="password" class="form-control" name="passwordHash" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–†–æ–ª—å *</label>
                                <select class="form-select" name="role.roleId" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                    ${referenceData.roles.map(r => 
                                        `<option value="${r.roleId}" ${item?.role?.roleId === r.roleId ? 'selected' : ''}>${r.roleName}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                    }
                    break;
                case 'courses':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" name="title" value="${item?.title || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                            <textarea class="form-control" name="description" required>${item?.description || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–¶–µ–Ω–∞ *</label>
                            <input type="number" step="0.01" class="form-control" name="price" value="${item?.price || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="teacher.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.filter(u => u.role?.roleName === '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å').map(u => 
                                    `<option value="${u.userId}" ${item?.teacher?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="courseStatus.courseStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.courseStatuses.map(s => 
                                    `<option value="${s.courseStatusId}" ${item?.courseStatus?.courseStatusId === s.courseStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select class="form-select" name="category.categoryId">
                                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                ${referenceData.categories.map(c => 
                                    `<option value="${c.categoryId}" ${item?.category?.categoryId === c.categoryId ? 'selected' : ''}>${c.categoryName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</label>
                            <input type="number" class="form-control" name="capacity" value="${item?.capacity || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                            <input type="date" class="form-control" name="startDate" value="${item?.startDate || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="date" class="form-control" name="endDate" value="${item?.endDate || ''}">
                        </div>
                    `;
                    break;
                case 'categories':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *</label>
                            <input type="text" class="form-control" name="categoryName" value="${item?.categoryName || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" name="description">${item?.description || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'enrollments':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="user.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName} (${u.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö—É—Ä—Å *</label>
                            <select class="form-select" name="course.courseId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                                ${referenceData.courses.map(c => 
                                    `<option value="${c.courseId}" ${item?.course?.courseId === c.courseId ? 'selected' : ''}>${c.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="enrollmentStatus.enrollmentStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.enrollmentStatuses.map(s => 
                                    `<option value="${s.enrollmentStatusId}" ${item?.enrollmentStatus?.enrollmentStatusId === s.enrollmentStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏</label>
                            <input type="date" class="form-control" name="enrollmentDate" value="${item?.enrollmentDate || new Date().toISOString().split('T')[0]}">
                        </div>
                    `;
                    break;
                case 'lessons':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ö—É—Ä—Å *</label>
                            <select class="form-select" name="course.courseId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                                ${referenceData.courses.map(c => 
                                    `<option value="${c.courseId}" ${item?.course?.courseId === c.courseId ? 'selected' : ''}>${c.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" name="title" value="${item?.title || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                            <textarea class="form-control" name="content" required>${item?.content || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</label>
                            <input type="text" class="form-control" name="attachedFile" value="${item?.attachedFile || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="lessonStatus.lessonStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.lessonStatuses.map(s => 
                                    `<option value="${s.lessonStatusId}" ${item?.lessonStatus?.lessonStatusId === s.lessonStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'tasks':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–£—Ä–æ–∫ *</label>
                            <select class="form-select" name="lesson.lessonId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫</option>
                                ${referenceData.lessons.map(l => 
                                    `<option value="${l.lessonId}" ${item?.lesson?.lessonId === l.lessonId ? 'selected' : ''}>${l.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" name="title" value="${item?.title || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                            <textarea class="form-control" name="description" required>${item?.description || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–µ–¥–ª–∞–π–Ω *</label>
                            <input type="date" class="form-control" name="deadline" value="${item?.deadline || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</label>
                            <input type="text" class="form-control" name="attachedFile" value="${item?.attachedFile || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="taskStatus.taskStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.taskStatuses.map(s => 
                                    `<option value="${s.taskStatusId}" ${item?.taskStatus?.taskStatusId === s.taskStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'solutions':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ó–∞–¥–∞–Ω–∏–µ *</label>
                            <select class="form-select" name="task.taskId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</option>
                                ${referenceData.tasks.map(t => 
                                    `<option value="${t.taskId}" ${item?.task?.taskId === t.taskId ? 'selected' : ''}>${t.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="user.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</label>
                            <textarea class="form-control" name="answerText">${item?.answerText || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–§–∞–π–ª –æ—Ç–≤–µ—Ç–∞</label>
                            <input type="text" class="form-control" name="answerFile" value="${item?.answerFile || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ *</label>
                            <input type="date" class="form-control" name="submitDate" value="${item?.submitDate || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="solutionStatus.solutionStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.solutionStatuses.map(s => 
                                    `<option value="${s.solutionStatusId}" ${item?.solutionStatus?.solutionStatusId === s.solutionStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–û—Ü–µ–Ω–∫–∞</label>
                            <select class="form-select" name="grade.gradeId">
                                <option value="">–ë–µ–∑ –æ—Ü–µ–Ω–∫–∏</option>
                                ${referenceData.grades ? referenceData.grades.map(g => 
                                    `<option value="${g.gradeId}" ${item?.grade?.gradeId === g.gradeId ? 'selected' : ''}>${g.gradeValue}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                    `;
                    break;
                case 'grades':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ (0-100) *</label>
                            <input type="number" min="0" max="100" class="form-control" name="gradeValue" value="${item?.gradeValue || ''}" required>
                        </div>
                    `;
                    break;
                case 'certificates':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="user.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö—É—Ä—Å *</label>
                            <select class="form-select" name="course.courseId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                                ${referenceData.courses.map(c => 
                                    `<option value="${c.courseId}" ${item?.course?.courseId === c.courseId ? 'selected' : ''}>${c.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ *</label>
                            <input type="text" class="form-control" name="certificateNumber" value="${item?.certificateNumber || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ *</label>
                            <input type="date" class="form-control" name="issueDate" value="${item?.issueDate || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É</label>
                            <input type="text" class="form-control" name="filePath" value="${item?.filePath || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–æ–∫—É–º–µ–Ω—Ç *</label>
                            <input type="text" class="form-control" name="documentFile" value="${item?.documentFile || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="certificateStatus.certificateStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.certificateStatuses.map(s => 
                                    `<option value="${s.certificateStatusId}" ${item?.certificateStatus?.certificateStatusId === s.certificateStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</label>
                            <select class="form-select" name="emailSent">
                                <option value="false" ${!item?.emailSent ? 'selected' : ''}>–ù–µ—Ç</option>
                                <option value="true" ${item?.emailSent ? 'selected' : ''}>–î–∞</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'checks':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="user.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö—É—Ä—Å</label>
                            <select class="form-select" name="course.courseId">
                                <option value="">–ë–µ–∑ –∫—É—Ä—Å–∞</option>
                                ${referenceData.courses.map(c => 
                                    `<option value="${c.courseId}" ${item?.course?.courseId === c.courseId ? 'selected' : ''}>${c.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—É–º–º–∞ *</label>
                            <input type="number" step="0.01" class="form-control" name="amount" value="${item?.amount || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ *</label>
                            <input type="date" class="form-control" name="paymentDate" value="${item?.paymentDate || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ *</label>
                            <select class="form-select" name="paymentStatus.paymentStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.paymentStatuses.map(s => 
                                    `<option value="${s.paymentStatusId}" ${item?.paymentStatus?.paymentStatusId === s.paymentStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'gift-cards':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                            <input type="text" class="form-control" name="cardNumber" value="${item?.cardNumber || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö–æ–¥ *</label>
                            <input type="text" class="form-control" name="code" value="${item?.code || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—É–º–º–∞ *</label>
                            <input type="number" step="0.01" class="form-control" name="amount" value="${item?.amount || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ë–∞–ª–∞–Ω—Å</label>
                            <input type="number" step="0.01" class="form-control" name="balance" value="${item?.balance || '0'}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ *</label>
                            <input type="date" class="form-control" name="issueDate" value="${item?.issueDate || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                            <input type="date" class="form-control" name="expiryDate" value="${item?.expiryDate || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                            <select class="form-select" name="user.userId">
                                <option value="">–ë–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö—É—Ä—Å</label>
                            <select class="form-select" name="course.courseId">
                                <option value="">–ë–µ–∑ –∫—É—Ä—Å–∞</option>
                                ${referenceData.courses.map(c => 
                                    `<option value="${c.courseId}" ${item?.course?.courseId === c.courseId ? 'selected' : ''}>${c.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                            <select class="form-select" name="giftCardStatus.giftCardStatusId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                ${referenceData.giftCardStatuses ? referenceData.giftCardStatuses.map(s => 
                                    `<option value="${s.giftCardStatusId}" ${item?.giftCardStatus?.giftCardStatusId === s.giftCardStatusId ? 'selected' : ''}>${s.statusName}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                    `;
                    break;
                case 'comments':
                    fields = `
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                            <select class="form-select" name="user.userId" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                ${referenceData.users.map(u => 
                                    `<option value="${u.userId}" ${item?.user?.userId === u.userId ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–£—Ä–æ–∫</label>
                            <select class="form-select" name="lesson.lessonId">
                                <option value="">–ë–µ–∑ —É—Ä–æ–∫–∞</option>
                                ${referenceData.lessons.map(l => 
                                    `<option value="${l.lessonId}" ${item?.lesson?.lessonId === l.lessonId ? 'selected' : ''}>${l.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ó–∞–¥–∞–Ω–∏–µ</label>
                            <select class="form-select" name="task.taskId">
                                <option value="">–ë–µ–∑ –∑–∞–¥–∞–Ω–∏—è</option>
                                ${referenceData.tasks.map(t => 
                                    `<option value="${t.taskId}" ${item?.task?.taskId === t.taskId ? 'selected' : ''}>${t.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è *</label>
                            <textarea class="form-control" name="text" required>${item?.text || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <input type="number" class="form-control" name="parentCommentId" value="${item?.parentCommentId || ''}">
                        </div>
                    `;
                    break;
                default:
                    fields = '<p class="text-muted">–§–æ—Ä–º–∞ –¥–ª—è —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞</p>';
            }
            
            return fields;
        }

        function saveItem(tableName, id) {
            const form = document.getElementById('crudForm');
            if (!form || !form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = {};

            if (tableName === 'users' && id !== null) {

                const roleId = formData.get('role.roleId');
                if (!roleId) {
                    alert('–†–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
                    return;
                }
                data.role = { roleId: parseInt(roleId) };
            } else {

                for (let [key, value] of formData.entries()) {
                    if (value === '') continue;
                    
                    if (key.includes('.')) {
                        const [parent, child] = key.split('.');
                        if (!data[parent]) data[parent] = {};
                        if (child === 'roleId' || child === 'userId' || child === 'courseId' || 
                            child === 'categoryId' || child === 'lessonId' || child === 'taskId' ||
                            child === 'gradeId' || child === 'enrollmentStatusId' || child === 'courseStatusId' ||
                            child === 'lessonStatusId' || child === 'taskStatusId' || child === 'solutionStatusId' ||
                            child === 'paymentStatusId' || child === 'certificateStatusId' || child === 'giftCardStatusId') {
                            data[parent][child] = parseInt(value);
                        } else {
                            data[parent][child] = value;
                        }
                    } else {
                        if (key === 'gradeValue' || key === 'capacity' || key === 'parentCommentId') {
                            data[key] = parseInt(value);
                        } else if (key === 'price' || key === 'amount' || key === 'balance') {
                            data[key] = parseFloat(value);
                        } else if (key === 'emailSent') {
                            data[key] = value === 'true';
                        } else {
                            data[key] = value;
                        }
                    }
                }
            }

            const endpoint = tableEndpoints[tableName];
            const method = id ? 'PUT' : 'POST';
            const url = id ? endpoint + '/' + id : endpoint;

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(text || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    });
                }
            })
            .then(result => {
                bootstrap.Modal.getInstance(document.getElementById('crudModal')).hide();
                loadTableData(tableName);

                if (tableName === 'users') loadUsers();
                else if (tableName === 'courses') loadCourses();
                else if (tableName === 'categories') loadCategories();
                else if (tableName === 'enrollments') loadEnrollments();
                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            })
            .catch(error => {
                console.error('Error saving:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
            });
        }

        function deleteItem(tableName, id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
            
            const endpoint = tableEndpoints[tableName];
            if (!endpoint) {
                console.error('Unknown table:', tableName);
                return;
            }

            fetch(endpoint + '/' + id, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => {
                if (response.ok) {
                    loadTableData(tableName);
                    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
                }
            })
            .catch(error => {
                console.error('Error deleting:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
            });
        }

        function loadEnrollmentStatuses() {
            fetch('/v1/api/admin/enrollment-statuses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(statuses => {
                enrollmentStatuses = statuses;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–ø–∏—Å–µ–π:', error);
            });
        }

        function showDeleteConfirmation(itemType, itemId) {
            document.getElementById('deleteItemType').value = itemType;
            document.getElementById('deleteItemId').value = itemId;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        function confirmDelete() {
            const itemType = document.getElementById('deleteItemType').value;
            const itemId = document.getElementById('deleteItemId').value;
            
            if (itemType === 'course') {
                fetch(`/v1/api/courses/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        deleteModal.hide();
                        loadCourses();
                        alert('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–∞');
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–∞: ' + error.message);
                });
            }
        }

        function showEditStatusModal(enrollmentId, currentStatusId) {
            document.getElementById('editEnrollmentId').value = enrollmentId;
            
            const statusSelect = document.getElementById('statusSelect');
            statusSelect.innerHTML = '';
            
            enrollmentStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.enrollmentStatusId;
                option.textContent = status.statusName;
                if (status.enrollmentStatusId == currentStatusId) {
                    option.selected = true;
                }
                statusSelect.appendChild(option);
            });
            
            const editModal = new bootstrap.Modal(document.getElementById('editStatusModal'));
            editModal.show();
        }

        function updateEnrollmentStatus() {
            const enrollmentId = document.getElementById('editEnrollmentId').value;
            const newStatusId = document.getElementById('statusSelect').value;
            
            fetch(`/v1/api/admin/enrollments/${enrollmentId}/status?statusId=${newStatusId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editStatusModal'));
                    editModal.hide();
                    loadEnrollments();
                    alert('–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏');
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏: ' + error.message);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function checkAndIssueCertificates() {
            const resultDiv = document.getElementById('certificateCheckResult');
            resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...</div>';

            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = 'Bearer ' + token;
            }

            fetch('/v1/api/admin/certificates/check-and-issue', {
                method: 'POST',
                headers: headers,
                credentials: 'include' // –í–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ cookies/—Å–µ—Å—Å–∏–∏
            })
            .then(response => {
                if (!response.ok && response.status === 401) {
                    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + data.message + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤') + '</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤: ' + error.message + '</div>';
            });
        }

        document.getElementById('users-tab').addEventListener('shown.bs.tab', function (e) {
            loadUsers();
        });

        document.getElementById('categories-tab').addEventListener('shown.bs.tab', function (e) {
            loadCategories();
        });

        document.getElementById('enrollments-tab').addEventListener('shown.bs.tab', function (e) {
            loadEnrollments();
        });

        document.getElementById('lessons-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('lessons');
        });

        document.getElementById('tasks-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('tasks');
        });

        document.getElementById('certificates-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('certificates');
        });

        document.getElementById('checks-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('checks');
        });

        document.getElementById('gift-cards-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('gift-cards');
        });

        document.getElementById('comments-tab').addEventListener('shown.bs.tab', function (e) {
            loadTableData('comments');
        });

        document.getElementById('courses-tab').addEventListener('shown.bs.tab', function (e) {
            loadCourses();
        });

        document.getElementById('reports-tab').addEventListener('shown.bs.tab', function (e) {
            loadReports();
        });

        document.getElementById('charts-tab').addEventListener('shown.bs.tab', function (e) {
            loadCharts();
        });

        document.getElementById('audit-tab').addEventListener('shown.bs.tab', function (e) {
            loadAuditLogs();
        });

        let statusChart = null;
        let revenueChart = null;
        let studentsChart = null;

        let auditLogsData = [];

        function loadReports() {
            fetch('/v1/api/admin/statistics/courses', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(reports => {
                const reportsList = document.getElementById('reportsList');
                if (reports.length === 0) {
                    reportsList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                        <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                                        <th>–°—Ç—É–¥–µ–Ω—Ç–æ–≤</th>
                                        <th>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</th>
                                        <th>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
                                        <th>–£—Ä–æ–∫–æ–≤</th>
                                        <th>–ó–∞–¥–∞–Ω–∏–π</th>
                                        <th>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</th>
                                        <th>–í—ã—Ä—É—á–∫–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    reports.forEach(report => {
                        let fillPercent = 'N/A';
                        if (report.fillPercentage !== null && report.fillPercentage !== undefined) {
                            fillPercent = report.fillPercentage.toFixed(1) + '%';
                        } else if (report.capacity !== null && report.capacity !== undefined) {

                            fillPercent = '0.0%';
                        }
                        const revenue = report.totalRevenue ? report.totalRevenue.toFixed(2) + ' —Ä—É–±.' : '0.00 —Ä—É–±.';
                        
                        html += `
                            <tr>
                                <td>${report.courseId || 'N/A'}</td>
                                <td><strong>${report.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong></td>
                                <td><span class="badge bg-info">${report.courseStatus || 'N/A'}</span></td>
                                <td>${report.categoryName || 'N/A'}</td>
                                <td>${report.teacherName || 'N/A'}</td>
                                <td>${report.enrolledStudents || 0}</td>
                                <td>${report.capacity || '‚àû'}</td>
                                <td>${fillPercent}</td>
                                <td>${report.lessonsCount || 0}</td>
                                <td>${report.tasksCount || 0}</td>
                                <td>${report.certificatesIssued || 0}</td>
                                <td><strong class="text-success">${revenue}</strong></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    reportsList.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                document.getElementById('reportsList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–æ–≤</p>';
            });
        }

        function updateCharts() {
            loadCharts();
        }

        function loadCharts() {

            const dateFrom = document.getElementById('dateFrom')?.value || '';
            const dateTo = document.getElementById('dateTo')?.value || '';

            let url = '/v1/api/admin/statistics/dashboard';
            if (dateFrom || dateTo) {
                url += '?';
                if (dateFrom) url += `dateFrom=${dateFrom}`;
                if (dateFrom && dateTo) url += '&';
                if (dateTo) url += `dateTo=${dateTo}`;
            }

            fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(stats => {

                const dashboardStats = document.getElementById('dashboardStats');
                dashboardStats.innerHTML = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h3>${stats.totalCourses || 0}</h3>
                                    <p class="mb-0">–í—Å–µ–≥–æ –∫—É—Ä—Å–æ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h3>${stats.totalStudents || 0}</h3>
                                    <p class="mb-0">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body">
                                    <h3>${stats.totalCertificates || 0}</h3>
                                    <p class="mb-0">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤—ã–¥–∞–Ω–æ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h3>${stats.totalRevenue ? stats.totalRevenue.toFixed(2) : '0.00'} —Ä—É–±.</h3>
                                    <p class="mb-0">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                if (statusChart) statusChart.destroy();
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                const statusCounts = stats.statusCounts || {};
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                if (revenueChart) revenueChart.destroy();
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                const topCourses = stats.topCourses || [];
                revenueChart = new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: topCourses.map(c => c.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').slice(0, 5),
                        datasets: [{
                            label: '–í—ã—Ä—É—á–∫–∞ (—Ä—É–±.)',
                            data: topCourses.map(c => c.totalRevenue ? parseFloat(c.totalRevenue) : 0).slice(0, 5),
                            backgroundColor: '#36A2EB'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                if (studentsChart) studentsChart.destroy();
                const studentsCtx = document.getElementById('studentsChart').getContext('2d');

                const dateFrom = document.getElementById('dateFrom')?.value || '';
                const dateTo = document.getElementById('dateTo')?.value || '';
                
                let coursesUrl = '/v1/api/admin/statistics/courses';


                
                fetch(coursesUrl, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                .then(response => response.json())
                .then(reports => {
                    const topByStudents = reports
                        .sort((a, b) => (b.enrolledStudents || 0) - (a.enrolledStudents || 0))
                        .slice(0, 5);
                    
                    studentsChart = new Chart(studentsCtx, {
                        type: 'line',
                        data: {
                            labels: topByStudents.map(c => c.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
                            datasets: [{
                                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤',
                                data: topByStudents.map(c => c.enrolledStudents || 0),
                                borderColor: '#4BC0C0',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading students chart data:', error);
                });
            })
                .catch(error => {
                    console.error('Error loading charts:', error);
                    document.getElementById('dashboardStats').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
            });
        }

        async function exportChartsToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                let yPosition = margin;

                pdf.setFontSize(18);
                pdf.text('Analytics and Charts Report', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;

                const dateFrom = document.getElementById('dateFrom')?.value || 'not specified';
                const dateTo = document.getElementById('dateTo')?.value || 'not specified';
                pdf.setFontSize(12);
                pdf.text(`Period: from ${dateFrom} to ${dateTo}`, margin, yPosition);
                yPosition += 10;
                const reportDate = new Date().toISOString().split('T')[0];
                pdf.text(`Report generated: ${reportDate}`, margin, yPosition);
                yPosition += 15;

                const charts = [
                    { id: 'statusChart', title: 'Course Status Statistics' },
                    { id: 'revenueChart', title: 'Top 5 Courses by Revenue' },
                    { id: 'studentsChart', title: 'Student Distribution by Courses' }
                ];

                for (let i = 0; i < charts.length; i++) {
                    const chartElement = document.getElementById(charts[i].id);
                    if (chartElement) {

                        if (yPosition > pageHeight - 80) {
                            pdf.addPage();
                            yPosition = margin;
                        }

                        pdf.setFontSize(14);
                        pdf.text(charts[i].title, margin, yPosition);
                        yPosition += 5;

                        const canvas = await html2canvas(chartElement, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });

                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = pageWidth - 2 * margin;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        if (yPosition + imgHeight > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }

                        pdf.addImage(imgData, 'PNG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                }

                const statsElement = document.getElementById('dashboardStats');
                if (statsElement) {
                    if (yPosition > pageHeight - 100) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.setFontSize(14);
                    pdf.text('General Statistics', margin, yPosition);
                    yPosition += 10;

                    const statsCanvas = await html2canvas(statsElement, {
                        backgroundColor: '#ffffff',
                        scale: 2
                    });

                    const statsImgData = statsCanvas.toDataURL('image/png');
                    const statsImgWidth = pageWidth - 2 * margin;
                    const statsImgHeight = (statsCanvas.height * statsImgWidth) / statsCanvas.width;

                    if (yPosition + statsImgHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }

                    pdf.addImage(statsImgData, 'PNG', margin, yPosition, statsImgWidth, statsImgHeight);
                }

                const fileName = `analytics_report_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                alert('Error exporting to PDF: ' + error.message);
            }
        }

        function loadAuditLogs() {
            const limit = document.getElementById('auditLimit') ? document.getElementById('auditLimit').value : 100;
            
            fetch(`/v1/api/admin/audit/logs?limit=${limit}`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(logs => {

                auditLogsData = logs;
                
                const auditLogsList = document.getElementById('auditLogsList');
                if (logs.length === 0) {
                    auditLogsList.innerHTML = '<p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ –∞—É–¥–∏—Ç–∞</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                                        <th>–¢–∞–±–ª–∏—Ü–∞</th>
                                        <th>ID –∑–∞–ø–∏—Å–∏</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                        <th>–î–µ—Ç–∞–ª–∏</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    logs.forEach((log, index) => {
                        const actionBadge = {
                            'INSERT': 'bg-success',
                            'UPDATE': 'bg-warning',
                            'DELETE': 'bg-danger'
                        }[log.action] || 'bg-secondary';
                        
                        const date = log.changedAt ? new Date(log.changedAt).toLocaleString('ru-RU') : 'N/A';
                        
                        html += `
                            <tr>
                                <td><small>${date}</small></td>
                                <td><code>${log.tableName || 'N/A'}</code></td>
                                <td>${log.recordId || 'N/A'}</td>
                                <td><span class="badge ${actionBadge}">${log.action || 'N/A'}</span></td>
                                <td>${log.userName || '–°–∏—Å—Ç–µ–º–∞'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" 
                                            data-log-index="${index}"
                                            onclick="showAuditDetailsFromButton(this)">
                                        <i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    auditLogsList.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading audit logs:', error);
                document.getElementById('auditLogsList').innerHTML = '<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞</p>';
            });
        }

        function showAuditDetailsFromButton(button) {
            const logIndex = parseInt(button.getAttribute('data-log-index'));
            if (logIndex >= 0 && logIndex < auditLogsData.length) {
                const log = auditLogsData[logIndex];
                showAuditDetails(log.auditId, log.oldValues || '', log.newValues || '');
            }
        }

        function showAuditDetails(auditId, oldValues, newValues) {
            let details = '<div class="row"><div class="col-md-6"><h6>–°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</h6><pre class="bg-light p-2" style="max-height: 400px; overflow-y: auto;">';
            try {
                if (oldValues && oldValues.trim()) {
                    const parsed = JSON.parse(oldValues);
                    details += escapeHtml(JSON.stringify(parsed, null, 2));
                } else {
                    details += escapeHtml(oldValues || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (e) {
                details += escapeHtml(oldValues || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
            }
            details += '</pre></div><div class="col-md-6"><h6>–ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</h6><pre class="bg-light p-2" style="max-height: 400px; overflow-y: auto;">';
            try {
                if (newValues && newValues.trim()) {
                    const parsed = JSON.parse(newValues);
                    details += escapeHtml(JSON.stringify(parsed, null, 2));
                } else {
                    details += escapeHtml(newValues || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (e) {
                details += escapeHtml(newValues || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
            }
            details += '</pre></div></div>';

            const existingModal = document.getElementById('auditDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'auditDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è #${auditId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToCsv(type) {
            const endpoints = {
                'users': '/v1/api/admin/export/users/csv',
                'courses': '/v1/api/admin/export/courses/csv',
                'enrollments': '/v1/api/admin/export/enrollments/csv',
                'statistics': '/v1/api/admin/export/statistics/csv'
            };

            const endpoint = endpoints[type];
            if (!endpoint) {
                alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            fetch(endpoint, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = blob.name || `${type}_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error exporting CSV:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            });
        }

        function importFromCsv(type, file) {
            if (!file) return;

            const endpoints = {
                'users': '/v1/api/admin/import/users/csv',
                'courses': '/v1/api/admin/import/courses/csv'
            };

            const endpoint = endpoints[type];
            if (!endpoint) {
                alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–º–ø–æ—Ä—Ç–∞');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const resultDiv = document.getElementById('importResult');
            resultDiv.innerHTML = '<div class="alert alert-info">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...</div>';

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                let html = '<div class="alert ';
                if (result.errors && result.errors.length > 0) {
                    html += 'alert-warning';
                } else {
                    html += 'alert-success';
                }
                html += '">';
                html += `<h6>–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–ø–æ—Ä—Ç–∞:</h6>`;
                html += `<p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.totalProcessed || 0}</p>`;
                if (result.successes && result.successes.length > 0) {
                    html += `<p class="text-success">–£—Å–ø–µ—à–Ω–æ: ${result.successes.length}</p>`;
                    if (result.successes.length <= 10) {
                        html += '<ul class="small">';
                        result.successes.forEach(msg => {
                            html += `<li>${escapeHtml(msg)}</li>`;
                        });
                        html += '</ul>';
                    }
                }
                if (result.skipped && result.skipped.length > 0) {
                    html += `<p class="text-warning">–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${result.skipped.length}</p>`;
                    if (result.skipped.length <= 10) {
                        html += '<ul class="small">';
                        result.skipped.forEach(msg => {
                            html += `<li>${escapeHtml(msg)}</li>`;
                        });
                        html += '</ul>';
                    }
                }
                if (result.errors && result.errors.length > 0) {
                    html += `<p class="text-danger">–û—à–∏–±–æ–∫: ${result.errors.length}</p>`;
                    html += '<ul class="small">';
                    result.errors.forEach(msg => {
                        html += `<li class="text-danger">${escapeHtml(msg)}</li>`;
                    });
                    html += '</ul>';
                }
                html += '</div>';
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error importing CSV:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + escapeHtml(error.message) + '</div>';
            });
        }
    </script>
</body>
</html>